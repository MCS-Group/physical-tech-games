<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical: Tech - Iron Ball Tug</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --team-red: #ff2d55;
            --team-red-glow: rgba(255, 45, 85, 0.6);
            --team-blue: #00d4ff;
            --team-blue-glow: rgba(0, 212, 255, 0.6);
            --gold: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.5);
            --dark-bg: #0a0a12;
            --arena-bg: #12121a;
        }

        body {
            background: var(--dark-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            overflow-x: hidden;
            padding: 20px;
            color: white;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 50%, var(--team-red-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, var(--team-blue-glow) 0%, transparent 50%);
            opacity: 0.3;
            pointer-events: none;
        }

        .game-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1400px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-family: 'Black Ops One', cursive;
            font-size: 3rem;
            background: linear-gradient(180deg, #fff 0%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 5px;
        }

        .subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: var(--gold);
            text-shadow: 0 0 15px var(--gold-glow);
            margin-top: 10px;
        }

        /* Scoreboard Section */
        .scoreboard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .team-panel {
            flex: 1;
            padding: 15px 20px;
            background: rgba(0,0,0,0.6);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .team-panel.red { border: 3px solid var(--team-red); box-shadow: 0 0 20px var(--team-red-glow); }
        .team-panel.blue { border: 3px solid var(--team-blue); box-shadow: 0 0 20px var(--team-blue-glow); }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-name {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
        }

        .team-panel.red .team-name { color: var(--team-red); }
        .team-panel.blue .team-name { color: var(--team-blue); }

        .rounds-won {
            display: flex;
            gap: 8px;
        }

        .round-dot {
            width: 15px;
            height: 15px;
            background: #333;
            border: 2px solid #555;
            transform: rotate(45deg);
        }

        .round-dot.won {
            background: var(--gold);
            border-color: #fff;
            box-shadow: 0 0 10px var(--gold);
        }

        .timer-container {
            text-align: center;
            padding: 10px 40px;
            background: rgba(0,0,0,0.8);
            border: 3px solid var(--gold);
            border-radius: 10px;
            margin: 0 20px;
        }

        .timer-label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: #888;
            margin-bottom: 5px;
        }

        .timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold-glow);
        }

        .timer.urgent {
            color: var(--team-red);
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Burst Meter */
        .burst-container {
            margin-top: 5px;
        }

        .burst-label {
            display: flex;
            justify-content: space-between;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .burst-bar-bg {
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
        }

        .burst-bar {
            height: 100%;
            width: 0%;
            transition: width 0.1s linear;
        }

        .team-panel.red .burst-bar { background: linear-gradient(90deg, var(--team-red), #ff8888); }
        .team-panel.blue .burst-bar { background: linear-gradient(90deg, var(--team-blue), #88ffff); }

        .burst-bar.ready {
            animation: burstGlow 0.5s infinite alternate;
        }

        @keyframes burstGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.5); }
        }

        /* Arena */
        .tug-arena {
            position: relative;
            background: var(--arena-bg);
            border: 4px solid #333;
            border-radius: 20px;
            height: 250px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* Tech Grid Background */
        .tug-arena::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        .center-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gold);
            box-shadow: 0 0 20px var(--gold-glow);
            transform: translateX(-50%);
            z-index: 5;
        }

        .checkpoint {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.1);
            z-index: 4;
        }
        .checkpoint.left { left: 15%; }
        .checkpoint.right { right: 15%; }

        .goal-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            color: rgba(255,255,255,0.1);
            pointer-events: none;
        }
        .goal-label.red { left: 20px; color: rgba(255, 45, 85, 0.2); }
        .goal-label.blue { right: 20px; color: rgba(0, 212, 255, 0.2); }

        /* The Rope & Ball */
        .track-container {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            height: 100px;
        }

        .rope {
            position: absolute;
            top: 50%;
            left: -50%;
            right: -50%;
            height: 8px;
            background: #555;
            transform: translateY(-50%);
            z-index: 10;
        }

        .iron-ball {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #fff, #888, #222);
            border-radius: 50%;
            border: 3px solid #000;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.05s linear;
        }

        .ball-weight {
            font-family: 'Black Ops One', cursive;
            font-size: 1rem;
            color: #000;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .iron-ball.bursting {
            animation: ballBurst 0.2s ease-in-out;
            box-shadow: 0 0 50px white;
        }

        @keyframes ballBurst {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Pullers */
        .puller {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            z-index: 15;
            transition: transform 0.1s;
        }
        .puller.red { left: 50px; }
        .puller.blue { right: 50px; transform: translateY(-50%) scaleX(-1); }

        .puller.active {
            filter: brightness(1.5);
        }

        /* Momentum Bar */
        .momentum-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .momentum-bar {
            width: 60%;
            height: 20px;
            background: #222;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 2px solid #444;
        }

        .momentum-fill {
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(90deg, var(--team-red) 0%, #333 50%, var(--team-blue) 100%);
            opacity: 0.3;
        }

        .momentum-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #fff;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px white;
            transition: left 0.05s linear;
        }

        /* Controls */
        .controls-wrapper {
            display: flex;
            gap: 20px;
            justify-content: center;
            width: 100%;
        }

        .control-box {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            text-align: center;
        }

        .control-box.red { border: 1px solid var(--team-red); }
        .control-box.blue { border: 1px solid var(--team-blue); }

        .key-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .key {
            width: 40px;
            height: 40px;
            background: #222;
            border: 2px solid #555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Black Ops One', cursive;
            color: #888;
            transition: all 0.05s;
        }

        .key.pressed { transform: scale(0.95); }
        .key.red.pressed { background: var(--team-red); border-color: #fff; color: white; box-shadow: 0 0 15px var(--team-red); }
        .key.blue.pressed { background: var(--team-blue); border-color: #fff; color: white; box-shadow: 0 0 15px var(--team-blue); }

        .burst-instruction {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--gold);
            margin-top: 10px;
        }

        /* Info Bar */
        .info-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 15px;
        }

        .info-item {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: #888;
        }
        .info-item span { color: var(--gold); }

        /* Player Characters Row */
        .players-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .team-players {
            display: flex;
            gap: 15px;
        }

        .team-players.blue {
            flex-direction: row-reverse;
        }

        .player-character {
            text-align: center;
        }

        .player-sprite {
            width: 80px;
            height: 100px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 5px;
            border: 3px solid;
            overflow: hidden;
        }

        .player-character.red .player-sprite {
            background: linear-gradient(180deg, var(--team-red), #aa1133);
            border-color: #ff6688;
            box-shadow: 0 0 15px var(--team-red-glow);
        }

        .player-character.blue .player-sprite {
            background: linear-gradient(180deg, var(--team-blue), #0088aa);
            border-color: #66ddff;
            box-shadow: 0 0 15px var(--team-blue-glow);
        }

        .player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-character-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.45rem;
            color: #ccc;
            margin-bottom: 3px;
        }

        .player-character-keys {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            color: var(--gold);
            font-weight: bold;
        }

        /* Overlay */
        .game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-overlay.hidden { display: none; }

        .overlay-title {
            font-family: 'Black Ops One', cursive;
            font-size: 3rem;
            color: white;
            margin-bottom: 10px;
        }

        .overlay-subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--gold);
            margin-bottom: 30px;
            text-align: center;
            line-height: 2;
        }

        .start-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            padding: 15px 50px;
            background: linear-gradient(180deg, var(--gold), #b8860b);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: #000;
            box-shadow: 0 0 20px var(--gold-glow);
        }

        .start-btn:hover { transform: scale(1.05); }

        .countdown {
            font-family: 'Black Ops One', cursive;
            font-size: 8rem;
            color: var(--gold);
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Winner Overlay Content */
        .winner-text {
            font-family: 'Black Ops One', cursive;
            font-size: 4rem;
            margin-bottom: 20px;
        }
        .winner-text.red { color: var(--team-red); text-shadow: 0 0 30px var(--team-red); }
        .winner-text.blue { color: var(--team-blue); text-shadow: 0 0 30px var(--team-blue); }

        .particle {
            position: fixed;
            pointer-events: none;
            width: 8px; height: 8px;
            border-radius: 50%;
            animation: fall 2s linear forwards;
        }
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }

        .dev-skip-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            color: #444;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 4px;
        }
        .dev-skip-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: white;
        }

    </style>
</head>
<body>
    <button class="dev-skip-btn" onclick="devSkip()">DEV: SKIP</button>

    <div class="game-wrapper">
        <div class="header">
            <div class="title">IRON BALL TUG</div>
            <div class="subtitle">GAME 3: POWER & RHYTHM</div>
        </div>

        <div class="info-bar">
            <div class="info-item">ROUND: <span id="round-display">1 / 3</span></div>
            <div class="info-item">WEIGHT: <span id="weight-display">100kg</span></div>
        </div>

        <!-- Player Characters Row -->
        <div class="scoreboard">
            <div class="team-panel red">
                <div class="team-header">
                    <div class="team-name">TEAM RED</div>
                    <div class="rounds-won">
                        <div class="round-dot" id="red-dot-0"></div>
                        <div class="round-dot" id="red-dot-1"></div>
                    </div>
                </div>
            </div>

            <div class="timer-container">
                <div class="timer-label">TIME REMAINING</div>
                <div class="timer" id="timer">45</div>
            </div>

            <div class="team-panel blue">
                <div class="team-header">
                    <div class="team-name">TEAM BLUE</div>
                    <div class="rounds-won">
                        <div class="round-dot" id="blue-dot-0"></div>
                        <div class="round-dot" id="blue-dot-1"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="players-row" id="players-row">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="tug-arena">
            <div class="center-line"></div>
            <div class="checkpoint left"></div>
            <div class="checkpoint right"></div>
            <div class="goal-label red">RED ZONE</div>
            <div class="goal-label blue">BLUE ZONE</div>

            <div class="track-container">
                <div class="rope"></div>
                <div class="puller red" id="puller-red">ðŸ¤–</div>
                <div class="puller blue" id="puller-blue">ðŸ¤–</div>
                <div class="iron-ball" id="iron-ball">
                    <span class="ball-weight" id="ball-text">100</span>
                </div>
            </div>
        </div>

        <div class="momentum-section">
            <div style="font-size: 0.6rem; color: var(--team-red);">RED PULL</div>
            <div class="momentum-bar">
                <div class="momentum-fill"></div>
                <div class="momentum-marker" id="momentum-marker"></div>
            </div>
            <div style="font-size: 0.6rem; color: var(--team-blue);">BLUE PULL</div>
        </div>

        <div class="controls-wrapper">
            <div class="control-box red">
                <div style="color: var(--team-red); font-family: 'Black Ops One'; margin-bottom: 10px;">RED CONTROLS</div>
                <div class="key-row">
                    <div class="key" id="key-q">Q</div><div class="key" id="key-a">A</div>
                </div>
                <div class="key-row">
                    <div class="key" id="key-w">W</div><div class="key" id="key-s">S</div>
                </div>
                <div class="key-row">
                    <div class="key" id="key-e">E</div><div class="key" id="key-d">D</div>
                </div>
            </div>

            <div class="control-box blue">
                <div style="color: var(--team-blue); font-family: 'Black Ops One'; margin-bottom: 10px;">BLUE CONTROLS</div>
                <div class="key-row">
                    <div class="key" id="key-u">U</div><div class="key" id="key-j">J</div>
                </div>
                <div class="key-row">
                    <div class="key" id="key-i">I</div><div class="key" id="key-k">K</div>
                </div>
                <div class="key-row">
                    <div class="key" id="key-o">O</div><div class="key" id="key-l">L</div>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY -->
    <div class="game-overlay" id="game-overlay">
        <div class="overlay-title">IRON BALL TUG</div>
        <div class="overlay-subtitle">
            3 VS 3 TECH TUG-OF-WAR<br>
            ALTERNATE KEYS FOR RHYTHM BONUS<br>
            BEST OF 3 ROUNDS
        </div>
        <button class="start-btn" onclick="startMatch()">START MATCH</button>
    </div>

    <script src="players.js"></script>
    <script src="audio-manager.js"></script>
    <script>
        // Initialize audio manager (music will start on button click)
        audioManager.initialize();

        // Tournament integration - load match data
        let matchData = null;
        const playerData = { red: [], blue: [] };
        try {
            const stored = localStorage.getItem('currentMatch');
            if (stored) {
                matchData = JSON.parse(stored);
                if (matchData.redPlayers) playerData.red = matchData.redPlayers;
                if (matchData.bluePlayers) playerData.blue = matchData.bluePlayers;
            }
        } catch (e) {
            console.log('No match data found, running standalone');
        }

        // Get player info helper
        function getPlayerInfo(playerId) {
            if (typeof PLAYERS !== 'undefined' && PLAYERS[playerId]) {
                return PLAYERS[playerId];
            }
            return null;
        }

        // CONFIG & STATE
        const config = {
            weights: [100, 180, 260],
            keys: {
                red: { pairs: [['q', 'a'], ['w', 's'], ['e', 'd']] },
                blue: { pairs: [['u', 'j'], ['i', 'k'], ['o', 'l']] }
            },
            pullPower: 0.35,
            rhythmBonus: 1.5,
            winThreshold: 5,
            roundsToWin: 2
        };

        const state = {
            running: false,
            round: 1,
            time: 45,
            ballPos: 50, // 0-100
            wins: { red: 0, blue: 0 },
            lastKeys: { red: {}, blue: {} },
            keys: {},
            roundHistory: []
        };

        // ELEMENTS
        const ball = document.getElementById('iron-ball');
        const marker = document.getElementById('momentum-marker');
        const overlay = document.getElementById('game-overlay');
        const timerEl = document.getElementById('timer');
        const ballText = document.getElementById('ball-text');
        const roundDisplay = document.getElementById('round-display');
        const weightDisplay = document.getElementById('weight-display');

        // Render player characters
        function renderPlayerControls() {
            const playersRow = document.getElementById('players-row');

            let redPlayersHTML = '';
            let bluePlayersHTML = '';

            for (let i = 0; i < 3; i++) {
                const redKeys = config.keys.red.pairs[i];
                const blueKeys = config.keys.blue.pairs[i];

                // Get player info for red team
                let redPlayerSprite = 'ðŸ‘¤';
                let redPlayerName = `Player ${i + 1}`;
                if (playerData.red && playerData.red[i]) {
                    const player = getPlayerInfo(playerData.red[i]);
                    if (player) {
                        redPlayerSprite = `<img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='ðŸ‘¤'">`;
                        redPlayerName = player.name;
                    }
                }

                // Get player info for blue team
                let bluePlayerSprite = 'ðŸ‘¤';
                let bluePlayerName = `Player ${i + 1}`;
                if (playerData.blue && playerData.blue[i]) {
                    const player = getPlayerInfo(playerData.blue[i]);
                    if (player) {
                        bluePlayerSprite = `<img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='ðŸ‘¤'">`;
                        bluePlayerName = player.name;
                    }
                }

                // Build players row HTML
                redPlayersHTML += `
                    <div class="player-character red">
                        <div class="player-sprite">${redPlayerSprite}</div>
                        <div class="player-character-name">${redPlayerName}</div>
                        <div class="player-character-keys">${redKeys[0].toUpperCase()} + ${redKeys[1].toUpperCase()}</div>
                    </div>
                `;

                bluePlayersHTML += `
                    <div class="player-character blue">
                        <div class="player-sprite">${bluePlayerSprite}</div>
                        <div class="player-character-name">${bluePlayerName}</div>
                        <div class="player-character-keys">${blueKeys[0].toUpperCase()} + ${blueKeys[1].toUpperCase()}</div>
                    </div>
                `;
            }

            // Populate players row
            playersRow.innerHTML = `
                <div class="team-players red">${redPlayersHTML}</div>
                <div class="team-players blue">${bluePlayersHTML}</div>
            `;
        }

        // CORE LOGIC
        function startMatch() {
            resetState();
            showCountdown();
        }

        function resetState() {
            state.round = 1;
            state.wins = { red: 0, blue: 0 };
            state.roundHistory = [];
            updateUI();
        }

        async function showCountdown() {
            overlay.classList.remove('hidden');
            overlay.innerHTML = '<div class="countdown">3</div>';

            // Play countdown audio FIRST (louder than background)
            audioManager.playCountdown().catch(() => {
                console.log('Countdown audio not available');
            });

            // Start background music with slight delay (500ms) so countdown is heard
            setTimeout(() => {
                audioManager.playBackgroundMusic('gameplay', true);
            }, 4000);

            await wait(1000);
            overlay.querySelector('.countdown').textContent = '2';
            await wait(1000);
            overlay.querySelector('.countdown').textContent = '1';
            await wait(1000);
            overlay.innerHTML = '<div class="countdown" style="color:var(--team-red)">PULL!</div>';
            await wait(500);
            overlay.classList.add('hidden');
            startRound();
        }

        function startRound() {
            state.running = true;
            state.ballPos = 50;
            state.time = 45;
            state.lastKeys = { red: {}, blue: {} };

            updateUI();
            
            state.timerInterval = setInterval(() => {
                state.time--;
                timerEl.textContent = state.time;
                if(state.time <= 10) timerEl.classList.add('urgent');
                else timerEl.classList.remove('urgent');

                if(state.time <= 0) {
                    endRound(state.ballPos < 50 ? 'red' : 'blue'); // Timeout winner based on side
                }
            }, 1000);
        }

        function endRound(winner) {
            state.running = false;
            clearInterval(state.timerInterval);
            state.wins[winner]++;
            state.roundHistory.push(winner);
            
            // Flash Winner
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0'; flash.style.bottom = '0'; flash.style.left = '0'; flash.style.right = '0';
            flash.style.backgroundColor = winner === 'red' ? 'rgba(255,45,85,0.5)' : 'rgba(0,212,255,0.5)';
            flash.style.zIndex = '500';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 200);

            if(state.wins[winner] >= config.roundsToWin) {
                endGame(winner);
            } else {
                state.round++;
                setTimeout(showCountdown, 1500);
            }
            updateUI();
        }

        function endGame(winner) {
            // Check for tournament data
            try {
                const stored = localStorage.getItem('currentMatch');
                if(stored) {
                    localStorage.setItem('gameResult', JSON.stringify({ winner: winner }));
                }
            } catch(e){}

            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <div class="winner-text ${winner}">${winner.toUpperCase()} WINS!</div>
                <div class="overlay-subtitle">SCORE: RED ${state.wins.red} - ${state.wins.blue} BLUE</div>
                <button class="start-btn" onclick="returnToFlow()">CONTINUE</button>
            `;
            createParticles(winner);
        }

        function returnToFlow() {
            // Check if match data exists to redirect properly
            let gameId = 3;
            try {
                const stored = localStorage.getItem('currentMatch');
                if(stored) gameId = JSON.parse(stored).game;
            } catch(e){}
            window.location.href = `game-flow.html?game=${gameId}`;
        }

        function updateUI() {
            // Ball
            const leftPerc = 10 + (state.ballPos * 0.8); // Clamp visually within track
            ball.style.left = `${leftPerc}%`;
            marker.style.left = `${state.ballPos}%`;
            
            // Info
            roundDisplay.textContent = `${state.round} / 3`;
            const currentWeight = config.weights[Math.min(state.round-1, 2)];
            weightDisplay.textContent = `${currentWeight}kg`;
            ballText.textContent = `${currentWeight}`;

            // Score Dots
            for(let i=0; i<2; i++) {
                document.getElementById(`red-dot-${i}`).className = `round-dot ${i < state.wins.red ? 'won' : ''}`;
                document.getElementById(`blue-dot-${i}`).className = `round-dot ${i < state.wins.blue ? 'won' : ''}`;
            }
        }

        // INPUT HANDLING
        document.addEventListener('keydown', (e) => {
            if(!state.running) return;
            const k = e.key.toLowerCase();
            if(state.keys[k]) return; // prevent hold
            state.keys[k] = true;

            // Handle Red Keys
            config.keys.red.pairs.forEach((pair, idx) => {
                if(pair.includes(k)) handlePull('red', idx, k);
            });

            // Handle Blue Keys
            config.keys.blue.pairs.forEach((pair, idx) => {
                if(pair.includes(k)) handlePull('blue', idx, k);
            });
        });

        document.addEventListener('keyup', (e) => {
            state.keys[e.key.toLowerCase()] = false;
            // Visual reset
            const map = {
                'q':'key-q', 'a':'key-a', 'w':'key-w', 's':'key-s', 'e':'key-e', 'd':'key-d',
                'u':'key-u', 'j':'key-j', 'i':'key-i', 'k':'key-k', 'o':'key-o', 'l':'key-l'
            };
            if(map[e.key.toLowerCase()]) {
                document.getElementById(map[e.key.toLowerCase()]).classList.remove('pressed', 'red', 'blue');
            }
        });

        function handlePull(team, pairIdx, key) {
            // Visual
            const keyId = key === 'o' ? 'key-o' : key === 'l' ? 'key-l' : `key-${key}`;
            const keyEl = document.getElementById(keyId);
            if(keyEl) keyEl.classList.add('pressed', team);

            // Puller animation
            const puller = document.getElementById(`puller-${team}`);
            puller.classList.remove('active');
            void puller.offsetWidth; // reset anim
            puller.classList.add('active');

            // Logic
            let power = config.pullPower;
            const weight = config.weights[Math.min(state.round-1, 2)];

            // Rhythm check
            const pair = config.keys[team].pairs[pairIdx];
            const otherKey = pair[0] === key ? pair[1] : pair[0];
            if(state.lastKeys[team][pairIdx] === otherKey) {
                power *= config.rhythmBonus; // Combo!
            }
            state.lastKeys[team][pairIdx] = key;

            // Apply weight resistance
            const realPower = power * (100 / weight);

            // Move Ball
            if(team === 'red') state.ballPos -= realPower;
            else state.ballPos += realPower;

            updateUI();

            // Win Condition
            if(state.ballPos <= config.winThreshold) endRound('red');
            if(state.ballPos >= 100 - config.winThreshold) endRound('blue');
        }

        function createParticles(winner) {
            const color = winner === 'red' ? '#ff2d55' : '#00d4ff';
            for(let i=0; i<50; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = color;
                p.style.left = Math.random() * 100 + 'vw';
                p.style.top = '-10px';
                p.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(p);
            }
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        function devSkip() {
            endGame('red');
        }

        // Initialize player controls on load
        renderPlayerControls();

    </script>
</body>
</html>