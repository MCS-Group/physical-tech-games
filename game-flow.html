<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHYSICAL: TECH - Game Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0a12;
            --gold: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.5);
            --red: #ff2d55;
            --red-glow: rgba(255, 45, 85, 0.5);
            --blue: #00d4ff;
            --blue-glow: rgba(0, 212, 255, 0.5);
            --green: #00ff88;
            --purple: #9945ff;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg-dark);
            font-family: 'Orbitron', sans-serif;
            color: white;
        }

        .bg-animation {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, var(--red-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, var(--blue-glow) 0%, transparent 50%);
            opacity: 0.3;
            animation: bgPulse 4s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes bgPulse {
            0% { opacity: 0.2; }
            100% { opacity: 0.4; }
        }

        /* ========== SCREEN SYSTEM ========== */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 40px;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
            animation: screenFadeIn 0.4s ease-out;
        }

        @keyframes screenFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ========== BACK BUTTON ========== */
        .back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            font-family: 'Black Ops One', cursive;
            font-size: 1rem;
            padding: 12px 25px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #444;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: #666;
            color: white;
        }

        /* ========== INTRO SCREEN ========== */
        .intro-badge {
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
            padding: 12px 40px;
            border-radius: 30px;
            border: 2px solid var(--gold);
            margin-bottom: 30px;
            box-shadow: 0 0 30px var(--gold-glow);
        }

        .intro-title {
            font-family: 'Black Ops One', cursive;
            font-size: 5rem;
            color: white;
            text-shadow: 0 5px 30px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            text-align: center;
        }

        .intro-screenshot-container {
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .intro-screenshot {
            max-width: 600px;
            width: 100%;
            height: auto;
            border-radius: 15px;
            border: 3px solid var(--gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 30px var(--gold-glow);
            filter: drop-shadow(0 5px 20px rgba(0,0,0,0.3));
            animation: screenshotFloat 3s ease-in-out infinite;
        }

        @keyframes screenshotFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .intro-description-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 40px;
            min-height: 100px;
            height: auto;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .intro-description {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            line-height: 1.6;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            letter-spacing: 2px;
            padding: 10 20px;
            text-align: center;
        }

        .intro-description.typing::after {
            content: '‚ñà';
            animation: cursorBlink 1s step-end infinite;
            margin-left: 5px;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .big-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 2.5rem;
            padding: 30px 100px;
            background: linear-gradient(180deg, var(--gold), #b8860b);
            border: none;
            border-radius: 20px;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 0 10px 0 #8b6914, 0 0 60px var(--gold-glow);
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        .big-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 0 #8b6914, 0 0 80px var(--gold-glow);
        }

        .big-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #8b6914;
        }

        /* ========== MATCHUP SCREEN ========== */
        .matchup-title {
            font-family: 'Black Ops One', cursive;
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 30px var(--gold-glow);
            margin-bottom: 40px;
        }

        .matchup-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            max-width: 1100px;
            width: 100%;
            margin-bottom: 40px;
        }

        .matchup-card {
            background: linear-gradient(180deg, rgba(20, 20, 35, 0.95), rgba(10, 10, 20, 0.95));
            border: 3px solid #333;
            border-radius: 15px;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
            width: calc(50% - 13px); /* Takes half width when multiple */
            min-width: 450px; /* Minimum width for centering when single */
        }

        .matchup-card.current {
            border-color: var(--gold);
            box-shadow: 0 0 40px var(--gold-glow);
            transform: scale(1.02);
        }

        .matchup-card.completed {
            border-color: var(--green);
            opacity: 0.6;
        }

        .matchup-team {
            flex: 1;
            text-align: center;
        }

        .matchup-team-name {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
        }

        .matchup-team.red .matchup-team-name { color: var(--red); }
        .matchup-team.blue .matchup-team-name { color: var(--blue); }

        .matchup-vs {
            font-family: 'Black Ops One', cursive;
            font-size: 2rem;
            color: var(--gold);
            padding: 0 25px;
        }

        .matchup-actions {
            display: flex;
            gap: 30px;
        }

        .action-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            padding: 20px 60px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .action-btn.shuffle {
            background: linear-gradient(180deg, var(--purple), #6622aa);
            color: white;
            box-shadow: 0 6px 0 #441177;
        }

        .action-btn.shuffle:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #441177, 0 0 30px rgba(153, 69, 255, 0.5);
        }

        .action-btn.confirm {
            background: linear-gradient(180deg, var(--gold), #b8860b);
            color: #1a1a1a;
            box-shadow: 0 6px 0 #8b6914;
        }

        .action-btn.confirm:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #8b6914, 0 0 30px var(--gold-glow);
        }

        /* ========== SELECTION SCREEN ========== */
        .selection-header {
            text-align: center;
            margin-bottom: 15px; /* Reduced margin */
            position: relative;
            z-index: 2;
        }

        .selection-team-badge {
            display: inline-block;
            font-family: 'Black Ops One', cursive;
            font-size: 2rem; /* Reduced size */
            padding: 10px 40px; /* Reduced padding */
            border-radius: 15px;
            margin-bottom: 5px;
        }
        
        /* Hide selection title as requested */
        .selection-title {
            display: none;
        }

        /* Player grid - Optimized for 1792px (Standard Layout) */
        .team-sections {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 15px;
            width: 100%;
            max-width: 1700px; /* Fixed max-width for consistency */
            margin-left: auto;
            margin-right: auto;
            gap: 60px;
        }

        .team-section {
            background: rgba(20, 20, 35, 0.8);
            border: 2px solid #333;
            border-radius: 15px;
            padding: 15px;
            flex: 0 0 auto; /* Don't grow, don't shrink */
            width: fit-content;
            max-height: 780px; /* Limit height to approx 3 rows */
            overflow-y: auto; /* Enable vertical scroll for 10th+ player */
            /* Hide scrollbar for Firefox */
            scrollbar-width: none;
            /* Hide scrollbar for IE, Edge and Firefox */
            -ms-overflow-style: none;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .team-section::-webkit-scrollbar {
            display: none;
        }


        .team-section-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem; /* Reduced */
            color: var(--purple);
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3x3 Grid */
            gap: 10px;
            padding-bottom: 0;
        }

        .player-card {
            background: linear-gradient(180deg, #2a2a3a, #1a1a2a);
            border: 3px solid #444;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            min-height: 240px; /* Compact height for grid */
        }

        .player-sprite {
            width: 100%; /* Fill card width */
            height: 180px; /* Compact height */
            margin: 0 auto 5px;
            background: #33333300;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            overflow: hidden;
        }

        .player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure full sprite is visible without cropping */
        }

        .player-name {
            font-family: 'Black Ops One', cursive;
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(to bottom, #ffffff 0%, #a0a0a0 50%, #707070 51%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 5px 0;
        }

        .player-card.selected {
            border-color: var(--green);
            background: linear-gradient(180deg, rgba(0, 255, 136, 0.15), rgba(0, 100, 50, 0.15));
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4), inset 0 0 10px rgba(0, 255, 136, 0.2);
            transform: translateY(-5px);
        }

        .player-card.selected .player-name { 
            background: linear-gradient(to bottom, #00ff88 0%, #00aa55 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.5));
        }

        .selection-check {
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 1rem;
            display: none;
        }

        .player-card.selected .selection-check { display: block; }

        .player-card.locked {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .player-card.locked::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
        }

        .ready-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 2rem;
            padding: 25px 80px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .ready-btn.red {
            background: linear-gradient(180deg, var(--red), #aa1133);
            color: white;
            box-shadow: 0 8px 0 #661122;
        }

        .ready-btn.blue {
            background: linear-gradient(180deg, var(--blue), #0088aa);
            color: white;
            box-shadow: 0 8px 0 #004466;
        }

        .ready-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .ready-btn:not(:disabled):hover {
            transform: translateY(-5px);
        }

        /* ========== PREVIEW SCREEN ========== */
        .preview-title {
            font-family: 'Black Ops One', cursive;
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 40px var(--gold-glow);
            margin-bottom: 10px;
        }

        .preview-match-info {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 40px;
        }

        .preview-teams {
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            gap: 40px; /* Reduced gap */
            margin-bottom: 30px;
            max-width: 1700px;
            width: 100%;
        }

        .preview-team {
            flex: 1;
            text-align: center;
            max-width: 600px;
        }

        .preview-team-name {
            font-family: 'Black Ops One', cursive;
            font-size: 2rem; /* Slightly reduced */
            margin-bottom: 15px;
        }

        .preview-team.red .preview-team-name {
            color: var(--red);
            text-shadow: 0 0 40px var(--red-glow);
        }

        .preview-team.blue .preview-team-name {
            color: var(--blue);
            text-shadow: 0 0 40px var(--blue-glow);
        }

        .preview-players {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3x2 Grid for 6 players */
            justify-content: center;
            gap: 10px;
        }

        .preview-player {
            background: rgba(30, 30, 45, 0.9);
            border-radius: 10px;
            padding: 8px;
            text-align: center;
        }

        .preview-team.red .preview-player { border: 2px solid var(--red); }
        .preview-team.blue .preview-player { border: 2px solid var(--blue); }

        .preview-player-sprite {
            width: 100%;
            height: 200px; /* More compact for preview grid */
            margin: 0 auto 8px;
            background: #33333300;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            overflow: hidden;
        }

        .preview-player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Consistent with selection */
            border-radius: 6px;
        }

        .preview-player-name {
            font-size: 0.75rem; /* Smaller for grid */
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-vs {
            font-family: 'Black Ops One', cursive;
            font-size: 4rem; /* Reduced */
            color: var(--gold);
            text-shadow: 0 0 60px var(--gold-glow);
            align-self: center;
            margin-top: 40px;
            animation: vsPulse 1s ease-in-out infinite;
        }

        @keyframes vsPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .begin-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            padding: 18px 50px;
            background: linear-gradient(180deg, var(--green), #00aa55);
            border: none;
            border-radius: 15px;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 0 6px 0 #006633, 0 0 40px rgba(0, 255, 136, 0.5);
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: beginPulse 2s ease-in-out infinite;
        }

        @keyframes beginPulse {
            0%, 100% { box-shadow: 0 6px 0 #006633, 0 0 40px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 6px 0 #006633, 0 0 60px rgba(0, 255, 136, 0.6); }
        }

        .begin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #006633, 0 0 60px rgba(0, 255, 136, 0.7);
        }

        /* ========== RESULT SCREEN ========== */
        .result-title {
            font-family: 'Black Ops One', cursive;
            font-size: 5rem;
            margin-bottom: 20px;
            animation: resultGlow 1s ease-in-out infinite alternate;
        }

        .result-title.red {
            color: var(--red);
            text-shadow: 0 0 60px var(--red-glow);
        }

        .result-title.blue {
            color: var(--blue);
            text-shadow: 0 0 60px var(--blue-glow);
        }

        @keyframes resultGlow {
            from { filter: brightness(1); transform: scale(1); }
            to { filter: brightness(1.3); transform: scale(1.03); }
        }

        .result-team-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: white;
            margin-bottom: 40px;
        }

        .result-players {
            display: flex;
            gap: 20px;
            margin-bottom: 50px;
            flex-wrap: nowrap; /* Single line */
            justify-content: center;
            overflow-x: auto;
            width: 100%;
        }

        .result-player {
            text-align: center;
            flex: 0 0 auto;
        }

        .result-player-sprite {
            width: 120px;
            height: 180px; /* Matched to grid scale */
            background: #00000000;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            animation: winnerBounce 0.5s ease-in-out infinite alternate;
            overflow: hidden;
        }

        .result-player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Full character visibility */
            border-radius: 12px;
        }

        @keyframes winnerBounce {
            from { transform: translateY(0); }
            to { transform: translateY(-15px); }
        }

        .result-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 2rem;
            padding: 25px 80px;
            background: linear-gradient(180deg, var(--gold), #b8860b);
            border: none;
            border-radius: 15px;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 0 8px 0 #8b6914;
            transition: all 0.2s;
        }

        .result-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 13px 0 #8b6914, 0 0 40px var(--gold-glow);
        }

        /* Confetti */
        @keyframes confettiFall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Audio Controls */
        .audio-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .audio-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px var(--gold-glow);
        }

        .audio-icon:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        .audio-icon.muted::before {
            content: 'üîá';
            position: absolute;
        }

        .audio-sliders {
            background: rgba(10, 10, 18, 0.95);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: all 0.3s;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }

        .audio-controls:hover .audio-sliders,
        .audio-sliders:hover {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-group label {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: var(--gold);
            text-transform: uppercase;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #333 0%, var(--gold) 100%);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--gold-glow);
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--gold-glow);
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Audio Controls -->
    <div class="audio-controls" id="audioControls">
        <div class="audio-icon" id="audioIcon">üîä</div>
        <div class="audio-sliders" id="audioSliders">
            <div class="slider-group">
                <label>Music</label>
                <input type="range" id="musicVolume" min="0" max="100" value="30">
            </div>
            <div class="slider-group">
                <label>SFX</label>
                <input type="range" id="sfxVolume" min="0" max="100" value="50">
            </div>
        </div>
    </div>

    <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê BACK</button>

    <!-- INTRO SCREEN -->
    <div class="screen" id="introScreen">
        <div class="intro-badge" id="introBadge">GAME 1</div>
        <h1 class="intro-title" id="introTitle">WALL PUSH</h1>
        <div class="intro-screenshot-container">
            <img class="intro-screenshot" id="introScreenshot" src="" alt="Game Screenshot">
        </div>
        <div class="intro-description-container">
            <div class="intro-description" id="introDescription"></div>
        </div>
        <button class="big-btn" onclick="showMatchups()">START GAME</button>
    </div>

    <!-- MATCHUP SCREEN -->
    <div class="screen" id="matchupScreen">
        <h1 class="matchup-title" id="matchupTitle">‚öîÔ∏è GAME 1 MATCHUPS</h1>
        <div class="matchup-grid" id="matchupGrid"></div>
        <div class="matchup-actions">
            <button class="action-btn shuffle" id="shuffleBtn" onclick="shuffleMatchups()">üé≤ SHUFFLE</button>
            <button class="action-btn confirm" onclick="confirmMatchups()">‚úì CONFIRM</button>
        </div>
    </div>

    <!-- SELECTION SCREEN -->
    <div class="screen" id="selectionScreen">
        <div class="selection-header">
            <div class="selection-team-badge" id="selectionBadge">RED TEAM</div>
            <h1 class="selection-title" id="selectionTitle">SELECT YOUR FIGHTERS</h1>
            <div class="selection-counter">
                Selected: <span id="selectionCount">0</span> / <span id="selectionRequired">6</span>
            </div>
        </div>
        <div class="team-sections" id="teamSections"></div>
        <button class="ready-btn" id="readyBtn" onclick="confirmSelection()" disabled>READY ‚Üí</button>
    </div>

    <!-- PREVIEW SCREEN -->
    <div class="screen" id="previewScreen">
        <h1 class="preview-title">‚öîÔ∏è MATCH READY!</h1>
        <p class="preview-match-info" id="previewMatchInfo">MATCH 1 OF 4</p>
        <div class="preview-teams">
            <div class="preview-team red">
                <div class="preview-team-name" id="previewRedName">TEAM RED</div>
                <div class="preview-players" id="previewRedPlayers"></div>
            </div>
            <div class="preview-vs">VS</div>
            <div class="preview-team blue">
                <div class="preview-team-name" id="previewBlueName">TEAM BLUE</div>
                <div class="preview-players" id="previewBluePlayers"></div>
            </div>
        </div>
        <button class="begin-btn" onclick="beginMatch()">‚ñ∂ BEGIN MATCH</button>
    </div>

    <!-- RESULT SCREEN -->
    <div class="screen" id="resultScreen">
        <h1 class="result-title" id="resultTitle">WINNER!</h1>
        <div class="result-team-name" id="resultTeamName">Team Name</div>
        <div class="result-players" id="resultPlayers"></div>
        <button class="result-btn" onclick="continueFlow()">CONTINUE ‚Üí</button>
    </div>

    <!-- SPLIT ANIMATION SCREEN -->
    <div class="screen" id="splitScreen">
        <div class="split-flash"></div>
        <div class="split-container">
            <h1 class="split-title">GAME 3 WINNER</h1>
            <div class="split-combined-name" id="splitCombinedName">COMBINED TEAM</div>
            <div class="split-message" id="splitMessage">FRIENDS BECOME ENEMIES</div>
            <div class="split-teams">
                <div class="split-team red" id="splitTeam1">TEAM 1</div>
                <div class="split-icon">‚ö°</div>
                <div class="split-team blue" id="splitTeam2">TEAM 2</div>
            </div>
        </div>
    </div>

    <style>
        /* Split Animation Styles */
        .split-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .split-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 30px;
            opacity: 0;
            animation: fadeIn 1s forwards;
        }

        .split-combined-name {
            font-family: 'Black Ops One', cursive;
            font-size: 5rem;
            color: white;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeIn 1s forwards 1s;
        }

        .split-message {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--red);
            margin-bottom: 50px;
            opacity: 0;
            text-transform: uppercase;
            letter-spacing: 5px;
            animation: pulseMessage 2s infinite 2.5s, fadeIn 0.5s forwards 2.5s;
        }

        @keyframes pulseMessage {
            0% { text-shadow: 0 0 10px var(--red); transform: scale(1); }
            50% { text-shadow: 0 0 30px var(--red), 0 0 50px var(--red); transform: scale(1.05); }
            100% { text-shadow: 0 0 10px var(--red); transform: scale(1); }
        }

        .split-teams {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0; /* Start touching */
            opacity: 0;
            animation: splitReveal 0.1s forwards 3.2s, splitAction 1.5s cubic-bezier(0.1, 0.7, 0.1, 1) forwards 3.3s;
            position: relative;
        }

        .split-team {
            font-family: 'Black Ops One', cursive;
            font-size: 4rem;
            padding: 20px 40px;
            border: 4px solid;
            border-radius: 15px;
            background: rgba(0,0,0,0.8);
            z-index: 2;
        }

        .split-team.red {
            color: var(--red);
            border-color: var(--red);
            box-shadow: 0 0 50px var(--red-glow);
            transform: translateX(50px); /* Overlap slightly */
        }

        .split-team.blue {
            color: var(--blue);
            border-color: var(--blue);
            box-shadow: 0 0 50px var(--blue-glow);
            transform: translateX(-50px); /* Overlap slightly */
        }

        .split-icon {
            font-size: 6rem;
            position: absolute;
            z-index: 3;
            opacity: 0;
            animation: iconBlast 0.5s ease-out forwards 3.3s;
            text-shadow: 0 0 50px white;
        }

        /* Flash of light */
        .split-flash {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            animation: screenFlash 0.5s ease-out forwards 3.3s;
        }

        @keyframes splitReveal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes splitAction {
            0% { gap: 0; }
            5% { gap: 0; transform: scale(1.1); } /* Anticipation */
            100% { gap: 600px; transform: scale(1); } /* Explosion */
        }

        @keyframes iconBlast {
            0% { opacity: 1; transform: scale(0); }
            50% { opacity: 1; transform: scale(2) rotate(20deg); }
            100% { opacity: 0; transform: scale(3) rotate(45deg); }
        }

        @keyframes screenFlash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script src="players.js"></script>
    <script src="game-state.js"></script>
    <script src="audio-manager.js"></script>
    <script>
        // Get game number from URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentGame = parseInt(urlParams.get('game')) || 1;

        // Audio control elements
        const audioIcon = document.getElementById('audioIcon');
        const musicVolumeSlider = document.getElementById('musicVolume');
        const sfxVolumeSlider = document.getElementById('sfxVolume');

        const GAME_FILES = {
            1: 'physical-tech-wall-push-v2.html',
            2: 'physical-tech-hanging-endurance.html',
            3: 'iron-ball-tug.html',
            4: 'castle-conquest-v3-3d.html'
        };

        let currentMatchups = [];
        let currentMatchIndex = 0;
        let selectedPlayers = [];
        let currentScreenName = 'intro';

        // Initialize audio controls
        function initAudioControls() {
            // Initialize audio manager
            audioManager.initialize();

            // Audio icon toggle mute
            audioIcon.addEventListener('click', () => {
                const isMuted = audioManager.toggleMute();
                audioIcon.classList.toggle('muted', isMuted);
            });

            // Music volume slider
            musicVolumeSlider.addEventListener('input', (e) => {
                audioManager.setBgMusicVolume(e.target.value / 100);
            });

            // SFX volume slider
            sfxVolumeSlider.addEventListener('input', (e) => {
                audioManager.setSfxVolume(e.target.value / 100);
            });

            // Start background music for game flow
            audioManager.playBackgroundMusic('gameFlow');
        }

        // Initialize
        function init() {
            // Initialize audio
            initAudioControls();

            const state = getState();
            const config = GAME_CONFIG[currentGame];

            // LOAD MATCHUPS LOGIC (Must be done first to ensure state is ready for result processing)
            const existingMatchups = state.matchups[currentGame] || [];
            const existingResults = state.results[currentGame] || [];

            if (existingMatchups.length > 0) {
                currentMatchups = existingMatchups;
            } else if (existingResults.length > 0) {
                console.warn("Matchups missing but results exist. Reconstructing from history...");
                currentMatchups = existingResults.map(r => ({
                    red: r.red,
                    blue: r.blue,
                    isOriginalTeams: r.isOriginalTeams
                }));
                setMatchups(currentGame, currentMatchups);
            }

            // Check if we're returning from a game with a result
            const gameResult = localStorage.getItem('gameResult');
            if (gameResult) {
                localStorage.removeItem('gameResult');
                const result = JSON.parse(gameResult);
                showResult(result.winner);
                return;
            }

            // Setup intro screen
            document.getElementById('introBadge').textContent = `GAME ${currentGame}`;
            document.getElementById('introScreenshot').src = config.screenshot || '';
            document.getElementById('introTitle').textContent = config.name.toUpperCase();

            // Setup typing animation for description
            const descriptionElement = document.getElementById('introDescription');
            if (config.description && descriptionElement) {
                typeText(descriptionElement, config.description, 40);
            }

            // Determine flow
            if (currentMatchups.length > 0) {
                currentMatchIndex = existingResults.length;

                // Check if all matches are done
                if (currentMatchIndex >= currentMatchups.length && currentMatchIndex >= config.matches) {
                    window.location.href = 'index.html';
                    return;
                }

                // For Game 4, show intro screen first even if matchups exist
                if (currentGame === 4 && !sessionStorage.getItem('game4IntroShown')) {
                    sessionStorage.setItem('game4IntroShown', 'true');
                    showScreen('introScreen');
                    return;
                }

                // Show matchups screen directly
                showMatchups();
                return;
            }

            showScreen('introScreen');
        }

        // Show screen (hide all others first)
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreenName = screenId.replace('Screen', '');
            updateBackButton();
        }

        // Update back button behavior
        function updateBackButton() {
            const btn = document.getElementById('backBtn');
            btn.style.display = currentScreenName === 'result' ? 'none' : 'block';
        }

        // Go back
        function goBack() {
            switch(currentScreenName) {
                case 'intro':
                    window.location.href = 'index.html';
                    break;
                case 'matchup':
                    showScreen('introScreen');
                    break;
                case 'selection':
                    showScreen('matchupScreen');
                    break;
                case 'preview':
                    startSelection('red');
                    break;
                default:
                    window.location.href = 'index.html';
            }
        }

        // Play Game 4 Intro Animation
        function playGame4Intro() {
            console.log('[SPLIT ANIM] Starting playGame4Intro at', Date.now());

            const state = getState();
            const combinedTeamId = state.bracket.game3Winner;

            if (!combinedTeamId) {
                showMatchups();
                return;
            }

            const combinedTeam = COMBINED_TEAMS[combinedTeamId];
            const redTeam = TEAMS[combinedTeam.originalTeams[0]];
            const blueTeam = TEAMS[combinedTeam.originalTeams[1]];

            console.log('[SPLIT ANIM] Teams:', redTeam.name, 'vs', blueTeam.name);

            // SOLUTION: Completely replace the split screen HTML to force animation restart
            const splitScreen = document.getElementById('splitScreen');

            // Save the original HTML template
            const freshHTML = `
                <div class="split-flash"></div>
                <div class="split-container">
                    <h1 class="split-title">GAME 3 WINNER</h1>
                    <div class="split-combined-name" id="splitCombinedName">${combinedTeam.name}</div>
                    <div class="split-message" id="splitMessage">FRIENDS BECOME ENEMIES</div>
                    <div class="split-teams">
                        <div class="split-team red" id="splitTeam1">${redTeam.name}</div>
                        <div class="split-icon">‚ö°</div>
                        <div class="split-team blue" id="splitTeam2">${blueTeam.name}</div>
                    </div>
                </div>
            `;

            // Replace entire content - this forces all CSS animations to restart
            splitScreen.innerHTML = freshHTML;
            console.log('[SPLIT ANIM] HTML replaced at', Date.now());

            // Show screen immediately
            showScreen('splitScreen');
            console.log('[SPLIT ANIM] Screen shown at', Date.now());

            // Log each element's animation state
            const title = document.querySelector('.split-title');
            const name = document.querySelector('.split-combined-name');
            const message = document.querySelector('.split-message');
            const teams = document.querySelector('.split-teams');

            function logElementState(label, el) {
                const styles = window.getComputedStyle(el);
                console.log(`[${label}] opacity: ${styles.opacity}, animation: ${styles.animation}, display: ${styles.display}`);
            }

            console.log('=== INITIAL STATE ===');
            logElementState('TITLE', title);
            logElementState('NAME', name);
            logElementState('MESSAGE', message);
            logElementState('TEAMS', teams);

            // Log state at key animation moments
            setTimeout(() => {
                console.log('=== AT 0.5s (Title should be fading in) ===');
                logElementState('TITLE', title);
            }, 500);

            setTimeout(() => {
                console.log('=== AT 1.5s (Name should be visible, fading in) ===');
                logElementState('TITLE', title);
                logElementState('NAME', name);
            }, 1500);

            setTimeout(() => {
                console.log('=== AT 3s (Message should be visible) ===');
                logElementState('MESSAGE', message);
            }, 3000);

            setTimeout(() => {
                console.log('=== AT 3.5s (Teams should be splitting) ===');
                logElementState('TEAMS', teams);
            }, 3500);

            // Epic intro rumble
            playSound(60, 'sawtooth', 0.8);
            playSound(80, 'triangle', 0.6);

            // Timeline with energetic sounds
            setTimeout(() => {
                // Team name reveal - rising power
                playSound(150, 'square', 0.15);
                setTimeout(() => playSound(200, 'square', 0.15), 50);
                setTimeout(() => playSound(250, 'square', 0.15), 100);
            }, 1000);

            setTimeout(() => {
                // Warning - ominous tension build
                playSound(80, 'sawtooth', 0.4);
                playSound(120, 'triangle', 0.3);
                // Rising siren effect
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => playSound(200 + i * 50, 'sine', 0.1), i * 100);
                }
            }, 2500);

            setTimeout(() => {
                // EXPLOSIVE SPLIT - Thunder crack!
                // Deep bass hit
                playSound(40, 'sawtooth', 0.3);
                setTimeout(() => playSound(50, 'square', 0.25), 20);

                // Thunder rumble (noise-like effect with multiple frequencies)
                setTimeout(() => {
                    playSound(100, 'sawtooth', 0.2);
                    playSound(150, 'square', 0.15);
                    playSound(200, 'triangle', 0.1);
                }, 50);

                // High crack/zap
                setTimeout(() => {
                    playSound(800, 'sine', 0.08);
                    playSound(1200, 'sine', 0.06);
                }, 80);

                // Echoing rumble
                setTimeout(() => playSound(70, 'sawtooth', 0.15), 150);
            }, 3300);

            // End animation and go to matchups
            setTimeout(() => {
                showScreen('matchupScreen');
            }, 5500);
        }

        // Show matchups screen
        function showMatchups() {
            const config = GAME_CONFIG[currentGame];
            document.getElementById('matchupTitle').textContent = `‚öîÔ∏è GAME ${currentGame} MATCHUPS`;

            if (currentMatchups.length === 0) {
                currentMatchups = generateMatchups(currentGame);
            }

            // Game 4 Special Split Animation (after intro screen)
            if (currentGame === 4) {
                console.log('[GAME FLOW] Game 4 split animation path triggered at', Date.now());
                // Ensure we have matchups generated first so we know who is fighting
                if (currentMatchups.length === 0) {
                    console.log('[GAME FLOW] Generating matchups at', Date.now());
                    currentMatchups = generateMatchups(currentGame);
                    console.log('[GAME FLOW] Matchups generated at', Date.now());
                }

                // Show split animation immediately, render matchups in background
                playGame4Intro();

                // Defer renderMatchups to avoid blocking the split animation
                setTimeout(() => renderMatchups(), 100);
                return;
            }


            renderMatchups();
            showScreen('matchupScreen');
        }

        // Render matchups
        function renderMatchups() {
            const grid = document.getElementById('matchupGrid');
            const state = getState();
            grid.innerHTML = '';

            const completedMatches = state.results[currentGame].length;

            // Disable shuffle if any match has been played (can't reshuffle mid-game)
            const shuffleBtn = document.getElementById('shuffleBtn');
            if (completedMatches > 0) {
                shuffleBtn.disabled = true;
                shuffleBtn.style.opacity = '0.4';
                shuffleBtn.style.cursor = 'not-allowed';
                shuffleBtn.title = 'Cannot shuffle after matches have started';
            } else {
                shuffleBtn.disabled = false;
                shuffleBtn.style.opacity = '1';
                shuffleBtn.style.cursor = 'pointer';
                shuffleBtn.title = '';
            }

            currentMatchups.forEach((matchup, index) => {
                const isCompleted = index < completedMatches;
                const isCurrent = index === completedMatches;

                let redTeam, blueTeam;
                // Use the flag from the specific matchup object, or fallback to game config
                const useOriginals = matchup.isOriginalTeams !== undefined ? matchup.isOriginalTeams : (currentGame === 4);

                if (useOriginals) {
                    redTeam = TEAMS[matchup.red];
                    blueTeam = TEAMS[matchup.blue];
                } else {
                    redTeam = COMBINED_TEAMS[matchup.red];
                    blueTeam = COMBINED_TEAMS[matchup.blue];
                }

                // Safety check if team not found
                if (!redTeam) redTeam = { name: `Unknown (${matchup.red})` };
                if (!blueTeam) blueTeam = { name: `Unknown (${matchup.blue})` };

                const card = document.createElement('div');
                card.className = `matchup-card ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;
                card.innerHTML = `
                    <div class="matchup-team red">
                        <div class="matchup-team-name">${redTeam.name}</div>
                    </div>
                    <div class="matchup-vs">${isCompleted ? '‚úì' : 'VS'}</div>
                    <div class="matchup-team blue">
                        <div class="matchup-team-name">${blueTeam.name}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Shuffle matchups with animation
        function shuffleMatchups() {
            // Safety check: don't allow shuffle if matches have been played
            const state = getState();
            if (state.results[currentGame].length > 0) {
                console.warn('Cannot shuffle: matches already played in this game');
                return;
            }

            const shuffleBtn = document.getElementById('shuffleBtn');
            const confirmBtn = document.querySelector('.action-btn.confirm');
            
            // Disable buttons during animation
            shuffleBtn.disabled = true;
            confirmBtn.disabled = true;
            shuffleBtn.style.opacity = '0.5';
            confirmBtn.style.opacity = '0.5';
            
            let shuffleCount = 0;
            const maxShuffles = 30; // 30 * 100ms = 3 seconds
            
            // Play initial sound
            playSound(400, 'sine', 0.1);

            const interval = setInterval(() => {
                // Generate temporary matchups
                currentMatchups = generateMatchups(currentGame);
                renderMatchups();
                
                // Play ticking sound
                if (shuffleCount % 5 === 0) playSound(200 + (shuffleCount * 10), 'triangle', 0.05);
                
                shuffleCount++;
                
                if (shuffleCount >= maxShuffles) {
                    clearInterval(interval);
                    
                    // Finalize
                    playSound(600, 'sine', 0.3); // Completion sound
                    
                    // Re-enable buttons
                    shuffleBtn.disabled = false;
                    confirmBtn.disabled = false;
                    shuffleBtn.style.opacity = '1';
                    confirmBtn.style.opacity = '1';
                    
                    // Add visual flair to the grid
                    const grid = document.getElementById('matchupGrid');
                    grid.style.transform = 'scale(1.02)';
                    setTimeout(() => grid.style.transform = 'scale(1)', 200);
                }
            }, 100);
        }

        // Confirm matchups
        function confirmMatchups() {
            playSound(600, 'sine', 0.15);
            setMatchups(currentGame, currentMatchups);
            currentMatchIndex = getState().results[currentGame].length;
            startSelection('red');
        }

        // Start player selection
        function startSelection(phase) {
            const config = GAME_CONFIG[currentGame];
            const matchup = currentMatchups[currentMatchIndex];
            const isRed = phase === 'red';

            let team;
            if (matchup.isOriginalTeams) {
                team = TEAMS[isRed ? matchup.red : matchup.blue];
            } else {
                team = COMBINED_TEAMS[isRed ? matchup.red : matchup.blue];
            }

            // Update UI
            const badge = document.getElementById('selectionBadge');
            badge.className = `selection-team-badge ${isRed ? 'red' : 'blue'}`;
            badge.textContent = `${isRed ? 'üî¥ RED' : 'üîµ BLUE'} TEAM`;

            document.getElementById('selectionTitle').textContent = team.name.toUpperCase();
            document.getElementById('selectionRequired').textContent = config.playersPerTeam;

            const readyBtn = document.getElementById('readyBtn');
            readyBtn.className = `ready-btn ${isRed ? 'red' : 'blue'}`;

            // Reset selection
            selectedPlayers = [];
            updateSelectionCount();

            // Render player grid
            renderPlayerSelection(team, matchup.isOriginalTeams);

            // Store current phase
            readyBtn.dataset.phase = phase;
            readyBtn.dataset.teamId = isRed ? matchup.red : matchup.blue;

            showScreen('selectionScreen');
        }

        // Render player selection grid
        function renderPlayerSelection(team, isOriginalTeam) {
            const container = document.getElementById('teamSections');
            const state = getState();
            container.innerHTML = '';

            // For Game 4, everyone is eligible (friends become enemies), so we ignore the played list
            const lockedPlayers = currentGame === 4 ? [] : state.playedPlayers;

            if (isOriginalTeam) {
                const section = createTeamSection(team.name, team.members, lockedPlayers);
                container.appendChild(section);
            } else {
                const originalTeam1 = TEAMS[team.originalTeams[0]];
                const originalTeam2 = TEAMS[team.originalTeams[1]];

                container.appendChild(createTeamSection(originalTeam1.name, originalTeam1.members, lockedPlayers));
                container.appendChild(createTeamSection(originalTeam2.name, originalTeam2.members, lockedPlayers));
            }
        }

        // Create team section
        function createTeamSection(teamName, memberIds, playedPlayers) {
            const section = document.createElement('div');
            section.className = 'team-section';
            section.innerHTML = `<div class="team-section-title">${teamName}</div>`;

            const grid = document.createElement('div');
            grid.className = 'players-grid';

            memberIds.forEach(playerId => {
                const player = PLAYERS[playerId];
                const isLocked = playedPlayers.includes(playerId);
                const isSelected = selectedPlayers.includes(playerId);

                const card = document.createElement('div');
                card.className = `player-card ${isLocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}`;
                card.dataset.playerId = playerId;

                card.innerHTML = `
                    <div class="player-sprite">
                        <img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='üë§'" alt="${player.name}">
                    </div>
                    <div class="player-name">${player.name}</div>
                    <div class="selection-check">‚úì</div>
                `;

                if (!isLocked) {
                    card.addEventListener('click', () => togglePlayer(playerId));
                }

                grid.appendChild(card);
            });

            section.appendChild(grid);
            return section;
        }

        // Toggle player selection
        function togglePlayer(playerId) {
            const config = GAME_CONFIG[currentGame];
            const index = selectedPlayers.indexOf(playerId);

            if (index > -1) {
                selectedPlayers.splice(index, 1);
            } else if (selectedPlayers.length < config.playersPerTeam) {
                selectedPlayers.push(playerId);
                playSound(500 + selectedPlayers.length * 50, 'sine', 0.1);
            }

            document.querySelectorAll('.player-card').forEach(card => {
                const id = parseInt(card.dataset.playerId);
                card.classList.toggle('selected', selectedPlayers.includes(id));
            });

            updateSelectionCount();
        }

        // Update selection counter
        function updateSelectionCount() {
            const config = GAME_CONFIG[currentGame];
            document.getElementById('selectionCount').textContent = selectedPlayers.length;
            document.getElementById('readyBtn').disabled = selectedPlayers.length !== config.playersPerTeam;
        }

        // Confirm selection
        function confirmSelection() {
            const readyBtn = document.getElementById('readyBtn');
            const phase = readyBtn.dataset.phase;
            const matchup = currentMatchups[currentMatchIndex];

            playSound(700, 'sine', 0.15);

            if (phase === 'red') {
                updateState({
                    currentMatchSetup: {
                        game: currentGame,
                        matchIndex: currentMatchIndex,
                        redTeam: matchup.red,
                        blueTeam: matchup.blue,
                        redPlayers: [...selectedPlayers],
                        bluePlayers: [],
                        isOriginalTeams: matchup.isOriginalTeams
                    }
                });
                startSelection('blue');
            } else {
                const state = getState();
                updateState({
                    currentMatchSetup: {
                        ...state.currentMatchSetup,
                        bluePlayers: [...selectedPlayers]
                    }
                });
                showPreview();
            }
        }

        // Show match preview
        function showPreview() {
            const state = getState();
            const setup = state.currentMatchSetup;
            const config = GAME_CONFIG[currentGame];

            let redTeam, blueTeam;
            if (setup.isOriginalTeams) {
                redTeam = TEAMS[setup.redTeam];
                blueTeam = TEAMS[setup.blueTeam];
            } else {
                redTeam = COMBINED_TEAMS[setup.redTeam];
                blueTeam = COMBINED_TEAMS[setup.blueTeam];
            }

            document.getElementById('previewMatchInfo').textContent = `MATCH ${currentMatchIndex + 1} OF ${config.matches}`;
            document.getElementById('previewRedName').textContent = redTeam.name;
            document.getElementById('previewBlueName').textContent = blueTeam.name;

            renderPreviewPlayers('previewRedPlayers', setup.redPlayers);
            renderPreviewPlayers('previewBluePlayers', setup.bluePlayers);

            showScreen('previewScreen');
        }

        // Render preview players
        function renderPreviewPlayers(containerId, playerIds) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            playerIds.forEach(playerId => {
                const player = PLAYERS[playerId];
                container.innerHTML += `
                    <div class="preview-player">
                        <div class="preview-player-sprite">
                            <img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='üë§'" alt="${player.name}">
                        </div>
                        <div class="preview-player-name">${player.name}</div>
                    </div>
                `;
            });
        }

        // Begin match
        function beginMatch() {
            const state = getState();
            const setup = state.currentMatchSetup;

            localStorage.setItem('currentMatch', JSON.stringify({
                game: currentGame,
                matchIndex: currentMatchIndex,
                redTeam: setup.redTeam,
                blueTeam: setup.blueTeam,
                redPlayers: setup.redPlayers,
                bluePlayers: setup.bluePlayers,
                isOriginalTeams: setup.isOriginalTeams
            }));

            window.location.href = GAME_FILES[currentGame];
        }

        let pendingWinner = null;

        // Show result
        function showResult(winner) {
            pendingWinner = winner;
            let state = getState();
            let setup = state.currentMatchSetup;

            // RECOVERY: Check if we have the actual match data from the game execution
            // This prevents desync if state.currentMatchSetup was lost or overwritten
            try {
                const executedMatchJson = localStorage.getItem('currentMatch');
                if (executedMatchJson) {
                    const executedMatch = JSON.parse(executedMatchJson);
                    // If the stored setup looks empty or different, use the executed match
                    if (!setup || !setup.redTeam || setup.redTeam !== executedMatch.redTeam) {
                        console.log("Restoring match setup from execution data");
                        setup = {
                            game: executedMatch.game,
                            matchIndex: executedMatch.matchIndex,
                            redTeam: executedMatch.redTeam,
                            blueTeam: executedMatch.blueTeam,
                            redPlayers: executedMatch.redPlayers,
                            bluePlayers: executedMatch.bluePlayers,
                            isOriginalTeams: executedMatch.isOriginalTeams
                        };
                        // Update state to match reality
                        updateState({ currentMatchSetup: setup });
                    }
                }
            } catch (e) {
                console.error("Error recovering match data", e);
            }

            const isRed = winner === 'red';

            let winnerTeam;
            if (setup.isOriginalTeams) {
                winnerTeam = TEAMS[isRed ? setup.redTeam : setup.blueTeam];
            } else {
                winnerTeam = COMBINED_TEAMS[isRed ? setup.redTeam : setup.blueTeam];
            }

            const winnerPlayers = isRed ? setup.redPlayers : setup.bluePlayers;

            const resultTitle = document.getElementById('resultTitle');
            resultTitle.className = `result-title ${isRed ? 'red' : 'blue'}`;
            resultTitle.textContent = `${isRed ? 'üî¥' : 'üîµ'} WINNER!`;

            document.getElementById('resultTeamName').textContent = winnerTeam.name;

            const container = document.getElementById('resultPlayers');
            container.innerHTML = '';
            winnerPlayers.forEach((playerId, i) => {
                const player = PLAYERS[playerId];
                container.innerHTML += `
                    <div class="result-player">
                        <div class="result-player-sprite" style="animation-delay: ${i * 0.1}s">
                            <img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='üë§'" alt="${player.name}">
                        </div>
                        <div style="font-size:0.7rem;color:#aaa;">${player.name}</div>
                    </div>
                `;
            });

            // recordMatchResult(winner); // Moved to continueFlow
            createConfetti(isRed ? 'red' : 'blue');
            showScreen('resultScreen');

            // Play victory sound
            audioManager.playSoundEffect('victory');
        }

        // Continue flow
        function continueFlow() {
            if (pendingWinner) {
                recordMatchResult(pendingWinner);
                pendingWinner = null;
            }
            
            const state = getState();
            const config = GAME_CONFIG[currentGame];

            currentMatchIndex = state.results[currentGame].length;

            if (currentMatchIndex >= config.matches) {
                if (currentGame === 4) {
                    window.location.href = 'celebration.html';
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                showMatchups();
            }
        }

        // Create confetti
        function createConfetti(color) {
            const colors = color === 'red'
                ? ['#ff2d55', '#ff6688', '#ffaacc', '#ffd700']
                : ['#00d4ff', '#66e5ff', '#aaeeff', '#ffd700'];

            for (let i = 0; i < 60; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}vw;
                        top: -20px;
                        width: ${8 + Math.random() * 12}px;
                        height: ${8 + Math.random() * 12}px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                        pointer-events: none;
                        z-index: 1000;
                        animation: confettiFall 3s linear forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // Sound effect (wrapper for backward compatibility)
        function playSound(freq, type, duration) {
            audioManager.playProceduralSound('custom', freq, duration);
        }

        // Typing animation for game description
        let typingTimeout = null;
        function typeText(element, text, speed = 50) {
            // Clear any existing timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            element.textContent = '';
            element.classList.add('typing');

            let index = 0;

            function typeNextChar() {
                if (index < text.length) {
                    element.textContent += text[index];
                    index++;

                    // Play typing sound occasionally (not every character to avoid noise)
                    if (index % 3 === 0) {
                        playSound(800 + Math.random() * 200, 'square', 0.02);
                    }

                    typingTimeout = setTimeout(typeNextChar, speed);
                } else {
                    // Typing complete - hide cursor after a delay
                    setTimeout(() => {
                        element.classList.remove('typing');
                    }, 1000);
                }
            }

            // Start typing after a short delay
            setTimeout(typeNextChar, 500);
        }

        // Listen for admin control changes from scoreboard.html
        window.addEventListener('storage', (e) => {
            if (e.key === 'physicalTechTournament') {
                const state = getState();

                // Handle forced match setup from admin
                if (state.currentMatchSetup && state.currentMatchSetup.redTeam && state.currentMatchSetup.blueTeam) {
                    // Check if this is an admin override (matchIndex 99)
                    if (state.currentMatchSetup.matchIndex === 99) {
                        console.log('Admin forced match detected:', state.currentMatchSetup);

                        // Navigate to preview screen
                        currentGame = state.currentMatchSetup.game || currentGame;
                        showPreview();
                    }
                }

                // Handle game phase changes
                if (state.currentGame && state.currentGame !== currentGame) {
                    console.log('Admin changed game phase to:', state.currentGame);
                    currentGame = state.currentGame;
                    loadGame();
                }

                // Handle force refresh
                if (state.lastRefresh) {
                    console.log('Admin triggered force refresh');
                    location.reload();
                }
            }
        });

        init();
    </script>
</body>
</html>