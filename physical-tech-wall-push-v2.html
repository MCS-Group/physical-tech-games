<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical: Tech - Wall Pushing Match</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --team-red: #ff2d55;
            --team-red-glow: rgba(255, 45, 85, 0.6);
            --team-blue: #00d4ff;
            --team-blue-glow: rgba(0, 212, 255, 0.6);
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --dark-bg: #0a0a12;
            --arena-bg: #12121a;
        }

        body {
            background: var(--dark-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            overflow-x: hidden;
            padding: 20px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 50%, var(--team-red-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, var(--team-blue-glow) 0%, transparent 50%);
            opacity: 0.3;
            pointer-events: none;
            animation: bgPulse 4s ease-in-out infinite alternate;
        }

        @keyframes bgPulse {
            from { opacity: 0.2; }
            to { opacity: 0.4; }
        }

        .game-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1400px;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .title {
            font-family: 'Black Ops One', cursive;
            font-size: 2.5rem;
            background: linear-gradient(180deg, #fff 0%, var(--gold) 50%, #b8860b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 6px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--gold);
            text-shadow: 0 0 15px var(--gold);
            margin-top: 5px;
        }

        .scoreboard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .team-score {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 30px;
            border-radius: 15px;
            background: rgba(0,0,0,0.5);
        }

        .team-score.red {
            border: 3px solid var(--team-red);
            box-shadow: 0 0 30px var(--team-red-glow);
        }

        .team-score.blue {
            border: 3px solid var(--team-blue);
            box-shadow: 0 0 30px var(--team-blue-glow);
        }

        .team-name {
            font-family: 'Black Ops One', cursive;
            font-size: 1.8rem;
        }

        .team-score.red .team-name { color: var(--team-red); }
        .team-score.blue .team-name { color: var(--team-blue); }

        .score-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            color: white;
            min-width: 60px;
            text-align: center;
        }

        .timer-container {
            text-align: center;
            padding: 15px 40px;
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            border: 3px solid var(--gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .timer-label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: #888;
            margin-bottom: 5px;
        }

        .timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold);
        }

        .timer.urgent {
            color: var(--team-red);
            text-shadow: 0 0 20px var(--team-red);
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .arena {
            background: var(--arena-bg);
            border: 4px solid #333;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 
                inset 0 0 100px rgba(0,0,0,0.8),
                0 0 50px rgba(0,0,0,0.5);
            position: relative;
        }

        .arena-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 10px;
        }

        .zone-label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            padding: 8px 20px;
            border-radius: 5px;
        }

        .zone-label.red {
            background: linear-gradient(90deg, var(--team-red), transparent);
            color: white;
        }

        .zone-label.blue {
            background: linear-gradient(270deg, var(--team-blue), transparent);
            color: white;
        }

        .battlefield {
            position: relative;
            height: 450px;
            background: linear-gradient(90deg, 
                rgba(255, 45, 85, 0.15) 0%, 
                rgba(255, 45, 85, 0.05) 20%,
                transparent 45%,
                transparent 55%,
                rgba(0, 212, 255, 0.05) 80%,
                rgba(0, 212, 255, 0.15) 100%
            );
            border-radius: 10px;
            overflow: hidden;
        }

        .center-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 6px;
            background: linear-gradient(180deg, 
                var(--gold) 0%, 
                #fff 50%, 
                var(--gold) 100%);
            transform: translateX(-50%);
            box-shadow: 0 0 20px var(--gold);
            z-index: 10;
        }

        .center-line::before {
            content: 'CENTER';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--gold);
            white-space: nowrap;
            background: var(--arena-bg);
            padding: 5px 10px;
            border-radius: 5px;
            border: 2px solid var(--gold);
        }

        .side-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            opacity: 0.1;
            pointer-events: none;
        }

        .side-zone.red {
            left: 0;
            color: var(--team-red);
        }

        .side-zone.blue {
            right: 0;
            color: var(--team-blue);
        }

        .block-lane {
            position: relative;
            height: 140px;
            margin-bottom: 15px;
            border-bottom: 2px dashed rgba(255,255,255,0.1);
        }

        .block-lane:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .weight-label {
            position: absolute;
            left: 50%;
            top: 5px;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: #555;
            z-index: 5;
            background: var(--arena-bg);
            padding: 2px 8px;
            border-radius: 3px;
        }

        .block {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-family: 'Black Ops One', cursive;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            transition: left 0.05s linear;
            z-index: 20;
        }

        .block.light {
            width: 100px;
            height: 80px;
            background: linear-gradient(180deg, #a0522d, #8B4513);
            border: 4px solid var(--bronze);
            box-shadow: 
                0 0 25px rgba(205, 127, 50, 0.6),
                inset 0 -10px 20px rgba(0,0,0,0.3);
            font-size: 1.3rem;
        }

        .block.medium {
            width: 120px;
            height: 90px;
            background: linear-gradient(180deg, #808080, #606060);
            border: 4px solid var(--silver);
            box-shadow: 
                0 0 25px rgba(192, 192, 192, 0.6),
                inset 0 -10px 20px rgba(0,0,0,0.3);
            font-size: 1.5rem;
        }

        .block.heavy {
            width: 140px;
            height: 100px;
            background: linear-gradient(180deg, #daa520, #b8860b);
            border: 4px solid var(--gold);
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.6),
                inset 0 -10px 20px rgba(0,0,0,0.3);
            font-size: 1.8rem;
        }

        .block-clicks {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.4rem;
            opacity: 0.7;
            margin-top: 3px;
        }

        .block.in-red-zone {
            border-color: var(--team-red) !important;
            box-shadow: 0 0 40px var(--team-red) !important;
        }

        .block.in-blue-zone {
            border-color: var(--team-blue) !important;
            box-shadow: 0 0 40px var(--team-blue) !important;
        }

        /* Heroes */
        .heroes-container {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 15;
        }

        .heroes-container.red { left: 20px; }
        .heroes-container.blue { right: 20px; }

        .hero {
            width: 140px;
            height: 90px;
            border-radius: 12px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            padding: 10px;
            background: rgba(20, 20, 30, 0.8);
            border: 3px solid #444;
        }

        .hero.red {
            border-color: rgba(255, 45, 85, 0.5);
        }

        .hero.blue {
            border-color: rgba(0, 212, 255, 0.5);
        }

        .hero.pushing {
            animation: heroPush 0.08s ease-out;
        }

        @keyframes heroPush {
            0% { transform: scaleX(1) scaleY(1); }
            50% { transform: scaleX(1.2) scaleY(0.85); }
            100% { transform: scaleX(1) scaleY(1); }
        }

        .hero-keys-display {
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        .hero-key-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(180deg, #555, #2a2a2a);
            border: 3px solid #777;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #111;
            transition: all 0.1s ease;
        }

        .hero-key-btn.pressed-red {
            background: var(--team-red);
            border-color: #ff6688;
            box-shadow: 0 0 20px var(--team-red-glow), 0 4px 0 #aa1133;
            transform: translateY(2px);
        }

        .hero-key-btn.pressed-blue {
            background: var(--team-blue);
            border-color: #66ddff;
            box-shadow: 0 0 20px var(--team-blue-glow), 0 4px 0 #0088aa;
            transform: translateY(2px);
        }

        /* Player Characters Row Outside Arena */
        .players-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .team-players {
            display: flex;
            gap: 15px;
        }

        .team-players.blue {
            flex-direction: row-reverse;
        }

        .player-character {
            text-align: center;
        }

        .player-sprite {
            width: 90px;
            height: 110px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 5px;
            border: 3px solid;
            overflow: hidden;
        }

        .player-character.red .player-sprite {
            background: linear-gradient(180deg, var(--team-red), #aa1133);
            border-color: #ff6688;
            box-shadow: 0 0 15px var(--team-red-glow);
        }

        .player-character.blue .player-sprite {
            background: linear-gradient(180deg, var(--team-blue), #0088aa);
            border-color: #66ddff;
            box-shadow: 0 0 15px var(--team-blue-glow);
        }

        .player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-character-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: #ccc;
            margin-bottom: 3px;
        }

        .player-character-keys {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: var(--gold);
            font-weight: bold;
        }

        .player-character-clicks {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.45rem;
            color: #888;
            margin-top: 5px;
        }

        /* Power meters */
        .power-display {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 10px;
        }

        .power-meter {
            width: 45%;
            padding: 10px 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }

        .power-meter.red { border: 2px solid var(--team-red); }
        .power-meter.blue { border: 2px solid var(--team-blue); }

        .power-label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .power-meter.red .power-label { color: var(--team-red); }
        .power-meter.blue .power-label { color: var(--team-blue); }

        .power-bar-container {
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
        }

        .power-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.1s ease;
        }

        .power-meter.red .power-bar {
            background: linear-gradient(90deg, #ff2d55, #ff6688);
            box-shadow: 0 0 10px var(--team-red);
        }

        .power-meter.blue .power-bar {
            background: linear-gradient(90deg, #00d4ff, #66e5ff);
            box-shadow: 0 0 10px var(--team-blue);
        }


        /* Settings */
        .settings-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .setting {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--gold);
        }

        .setting select {
            font-family: 'Orbitron', sans-serif;
            padding: 8px 15px;
            background: #1a1a2e;
            border: 2px solid var(--gold);
            border-radius: 5px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Overlay */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .game-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .overlay-title {
            font-family: 'Black Ops One', cursive;
            font-size: 3.5rem;
            color: white;
            margin-bottom: 10px;
        }

        .overlay-subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 40px;
        }

        .start-btn {
            font-family: 'Black Ops One', cursive;
            font-size: 1.8rem;
            padding: 20px 60px;
            background: linear-gradient(180deg, var(--gold), #b8860b);
            border: none;
            border-radius: 15px;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 
                0 0 30px var(--gold),
                0 8px 0 #8b6914;
            transition: all 0.1s ease;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 50px var(--gold), 0 11px 0 #8b6914;
        }

        .start-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 30px var(--gold), 0 0 0 #8b6914;
        }

        .countdown {
            font-family: 'Black Ops One', cursive;
            font-size: 10rem;
            color: var(--gold);
            text-shadow: 0 0 50px var(--gold);
            animation: countPulse 1s ease-in-out;
        }

        @keyframes countPulse {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0; }
        }

        .winner-display {
            text-align: center;
        }

        .winner-text {
            font-family: 'Black Ops One', cursive;
            font-size: 3.5rem;
            margin-bottom: 20px;
            animation: winnerPulse 0.5s ease-in-out infinite alternate;
        }

        .winner-text.red {
            color: var(--team-red);
            text-shadow: 0 0 50px var(--team-red);
        }

        .winner-text.blue {
            color: var(--team-blue);
            text-shadow: 0 0 50px var(--team-blue);
        }

        .winner-text.draw {
            color: var(--gold);
            text-shadow: 0 0 50px var(--gold);
        }

        @keyframes winnerPulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .final-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: white;
            margin-bottom: 15px;
        }

        .score-breakdown {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: #888;
            margin-bottom: 30px;
            line-height: 2;
        }

        .particle {
            position: fixed;
            pointer-events: none;
            z-index: 999;
            animation: particleFall 2.5s linear forwards;
        }

        @keyframes particleFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Push effect indicator */
        .push-indicator {
            position: absolute;
            font-size: 0.8rem;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            animation: pushIndicator 0.5s ease-out forwards;
        }

        @keyframes pushIndicator {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-30px) scale(1.5); }
        }

        .dev-skip-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            color: #444;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 4px;
        }
        .dev-skip-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: white;
        }
    </style>
</head>
<body>
    <button class="dev-skip-btn" onclick="devSkip()">DEV: SKIP</button>

    <div class="game-wrapper">
        <div class="header">
            <div class="title">PHYSICAL: TECH</div>
            <div class="subtitle">‚öîÔ∏è WALL PUSHING MATCH ‚öîÔ∏è</div>
        </div>

        <div class="scoreboard">
            <div class="team-score red">
                <div class="team-name">RED</div>
                <div class="score-value" id="score-red">0</div>
            </div>
            <div class="timer-container">
                <div class="timer-label">TIME REMAINING</div>
                <div class="timer" id="timer">60</div>
            </div>
            <div class="team-score blue">
                <div class="score-value" id="score-blue">0</div>
                <div class="team-name">BLUE</div>
            </div>
        </div>

        <!-- Player Characters Row -->
        <div class="players-row" id="players-row">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="arena">
            <div class="arena-header">
                <div class="zone-label red">‚óÄ BLUE SCORES HERE</div>
                <div class="zone-label blue">RED SCORES HERE ‚ñ∂</div>
            </div>

            <div class="battlefield" id="battlefield">
                <div class="center-line"></div>
                <div class="side-zone red">RED</div>
                <div class="side-zone blue">BLUE</div>
            </div>

            <div class="power-display">
                <div class="power-meter red">
                    <div class="power-label">
                        <span>TEAM RED POWER</span>
                    </div>
                    <div class="power-bar-container">
                        <div class="power-bar" id="power-red" style="width: 0%"></div>
                    </div>
                </div>
                <div class="power-meter blue">
                    <div class="power-label">
                        <span>TEAM BLUE POWER</span>
                    </div>
                    <div class="power-bar-container">
                        <div class="power-bar" id="power-blue" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="game-overlay" id="game-overlay">
        <div class="overlay-title">WALL PUSHING MATCH</div>
        <div class="overlay-subtitle">6 PLAYERS ‚Ä¢ PUSH TO WIN</div>
        <div class="settings-row" style="margin-bottom: 20px;">
            <div class="setting">
                <label>TIME:</label>
                <select id="time-select">
                    <option value="30">30 sec</option>
                    <option value="45">45 sec</option>
                    <option value="60" selected>60 sec</option>
                    <option value="90">90 sec</option>
                    <option value="120">120 sec</option>
                </select>
            </div>
        </div>
        <button class="start-btn" id="start-btn">START MATCH</button>
    </div>

    <script src="players.js"></script>
    <script src="audio-manager.js"></script>
    <script>
        // Initialize audio manager (music will start on button click)
        audioManager.initialize();

        // Tournament integration - load match data
        let matchData = null;
        try {
            const stored = localStorage.getItem('currentMatch');
            if (stored) {
                matchData = JSON.parse(stored);
            }
        } catch (e) {
            console.log('No match data found, running standalone');
        }

        // Get player info helper
        function getPlayerInfo(playerId) {
            if (typeof PLAYERS !== 'undefined' && PLAYERS[playerId]) {
                return PLAYERS[playerId];
            }
            return null;
        }

        // Game configuration
        const config = {
            blocks: [
                { weight: 100, class: 'light', clicksToMove: 3, label: '100KG' },   // Need 3 net alternating clicks to move
                { weight: 300, class: 'heavy', clicksToMove: 10, label: '300KG' },  // Need 10 net alternating clicks
                { weight: 200, class: 'medium', clicksToMove: 6, label: '200KG' }   // Need 6 net alternating clicks
            ],
            keyMappings: {
                red: [
                    ['q', 'a'],  // Player 1
                    ['w', 's'],  // Player 2
                    ['e', 'd']   // Player 3
                ],
                blue: [
                    ['u', 'j'],  // Player 1
                    ['i', 'k'],  // Player 2
                    ['o', 'l']   // Player 3
                ]
            },
            moveAmount: 2,      // Percentage to move per successful push
            defaultTime: 60
        };

        // Game state
        const state = {
            isRunning: false,
            timeLeft: 60,
            totalTime: 60,
            blocks: [],
            clicks: { red: 0, blue: 0 },
            playerClicks: { red: [0, 0, 0], blue: [0, 0, 0] },
            lastKeyPressed: { red: [{}, {}, {}], blue: [{}, {}, {}] },
            pushProgress: { red: [0, 0, 0], blue: [0, 0, 0] },
            keysPressed: {},
            timerInterval: null
        };

        // DOM elements
        const battlefield = document.getElementById('battlefield');
        const gameOverlay = document.getElementById('game-overlay');
        const startBtn = document.getElementById('start-btn');
        const timerEl = document.getElementById('timer');
        const scoreRedEl = document.getElementById('score-red');
        const scoreBlueEl = document.getElementById('score-blue');
        const timeSelect = document.getElementById('time-select');

        // Initialize arena
        function initArena() {
            battlefield.querySelectorAll('.block-lane').forEach(el => el.remove());
            state.blocks = [];
            state.clicks = { red: 0, blue: 0 };
            state.playerClicks = { red: [0, 0, 0], blue: [0, 0, 0] };
            state.pushProgress = { red: [0, 0, 0], blue: [0, 0, 0] };
            state.lastKeyPressed = { red: [{}, {}, {}], blue: [{}, {}, {}] };

            config.blocks.forEach((blockConfig, index) => {
                const lane = document.createElement('div');
                lane.className = 'block-lane';
                lane.innerHTML = `<div class="weight-label">${blockConfig.label}</div>`;

                // Red hero (left side - pushing RIGHT toward blue)
                const redHeroes = document.createElement('div');
                redHeroes.className = 'heroes-container red';

                const redKey1 = config.keyMappings.red[index][0].toUpperCase();
                const redKey2 = config.keyMappings.red[index][1].toUpperCase();

                redHeroes.innerHTML = `
                    <div class="hero red" id="hero-red-${index}">
                        <div class="hero-keys-display">
                            <div class="hero-key-btn" data-key="${config.keyMappings.red[index][0]}">${redKey1}</div>
                            <div class="hero-key-btn" data-key="${config.keyMappings.red[index][1]}">${redKey2}</div>
                        </div>
                    </div>
                `;
                lane.appendChild(redHeroes);

                // Block
                const block = document.createElement('div');
                block.className = `block ${blockConfig.class}`;
                block.id = `block-${index}`;
                block.innerHTML = `${blockConfig.label}<span class="block-clicks" id="block-clicks-${index}">0</span>`;
                lane.appendChild(block);

                // Blue hero (right side - pushing LEFT toward red)
                const blueHeroes = document.createElement('div');
                blueHeroes.className = 'heroes-container blue';

                const blueKey1 = config.keyMappings.blue[index][0].toUpperCase();
                const blueKey2 = config.keyMappings.blue[index][1].toUpperCase();

                blueHeroes.innerHTML = `
                    <div class="hero blue" id="hero-blue-${index}">
                        <div class="hero-keys-display">
                            <div class="hero-key-btn" data-key="${config.keyMappings.blue[index][0]}">${blueKey1}</div>
                            <div class="hero-key-btn" data-key="${config.keyMappings.blue[index][1]}">${blueKey2}</div>
                        </div>
                    </div>
                `;
                lane.appendChild(blueHeroes);

                battlefield.appendChild(lane);

                state.blocks.push({
                    element: block,
                    position: 50,
                    netPush: 0,
                    clicksToMove: blockConfig.clicksToMove
                });
            });

            updateScoreDisplay();
        }

        // Render player characters
        function renderControls() {
            const playersRow = document.getElementById('players-row');

            let redPlayersHTML = '';
            let bluePlayersHTML = '';

            for (let i = 0; i < 3; i++) {
                const redKeys = config.keyMappings.red[i];
                const blueKeys = config.keyMappings.blue[i];

                // Get player info for red team
                let redPlayerSprite = 'üë§';
                let redPlayerName = `Player ${i + 1}`;
                if (matchData && matchData.redPlayers && matchData.redPlayers[i]) {
                    const player = getPlayerInfo(matchData.redPlayers[i]);
                    if (player) {
                        redPlayerSprite = `<img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='üë§'">`;
                        redPlayerName = player.name;
                    }
                }

                // Get player info for blue team
                let bluePlayerSprite = 'üë§';
                let bluePlayerName = `Player ${i + 1}`;
                if (matchData && matchData.bluePlayers && matchData.bluePlayers[i]) {
                    const player = getPlayerInfo(matchData.bluePlayers[i]);
                    if (player) {
                        bluePlayerSprite = `<img src="assets/sprites/${player.sprite}" onerror="this.parentElement.innerHTML='üë§'">`;
                        bluePlayerName = player.name;
                    }
                }

                // Build players row HTML
                redPlayersHTML += `
                    <div class="player-character red">
                        <div class="player-sprite">${redPlayerSprite}</div>
                        <div class="player-character-name">${redPlayerName}</div>
                        <div class="player-character-keys">${redKeys[0].toUpperCase()} + ${redKeys[1].toUpperCase()}</div>
                        <div class="player-character-clicks" id="player-clicks-red-${i}">0 clicks</div>
                    </div>
                `;

                bluePlayersHTML += `
                    <div class="player-character blue">
                        <div class="player-sprite">${bluePlayerSprite}</div>
                        <div class="player-character-name">${bluePlayerName}</div>
                        <div class="player-character-keys">${blueKeys[0].toUpperCase()} + ${blueKeys[1].toUpperCase()}</div>
                        <div class="player-character-clicks" id="player-clicks-blue-${i}">0 clicks</div>
                    </div>
                `;
            }

            // Populate players row
            playersRow.innerHTML = `
                <div class="team-players red">${redPlayersHTML}</div>
                <div class="team-players blue">${bluePlayersHTML}</div>
            `;
        }

        // Handle key press
        function handleKeyDown(e) {
            const key = e.key.toLowerCase();

            // Add glow effect to hero keys in arena
            ['red', 'blue'].forEach(team => {
                config.keyMappings[team].forEach((keys, blockIndex) => {
                    keys.forEach((k, keyIndex) => {
                        if (k === key) {
                            const heroKeyBtns = document.querySelectorAll(`#hero-${team}-${blockIndex} .hero-key-btn`);
                            if (heroKeyBtns[keyIndex]) {
                                heroKeyBtns[keyIndex].classList.add(`pressed-${team}`);
                            }
                        }
                    });
                });
            });

            if (!state.isRunning) return;
            if (state.keysPressed[key]) return;
            state.keysPressed[key] = true;

            ['red', 'blue'].forEach(team => {
                config.keyMappings[team].forEach((keys, blockIndex) => {
                    const keyIndex = keys.indexOf(key);
                    if (keyIndex !== -1) {
                        const lastKey = state.lastKeyPressed[team][blockIndex];
                        
                        // Check for alternating press
                        if (lastKey.key !== undefined && lastKey.key !== keyIndex) {
                            // Successful alternating press!
                            state.clicks[team]++;
                            state.playerClicks[team][blockIndex]++;

                            // Add to push progress
                            if (team === 'red') {
                                state.pushProgress.red[blockIndex]++;
                                state.pushProgress.blue[blockIndex] = Math.max(0, state.pushProgress.blue[blockIndex] - 0.5);
                            } else {
                                state.pushProgress.blue[blockIndex]++;
                                state.pushProgress.red[blockIndex] = Math.max(0, state.pushProgress.red[blockIndex] - 0.5);
                            }

                            // Check if enough progress to move block
                            const block = state.blocks[blockIndex];
                            const netProgress = state.pushProgress.red[blockIndex] - state.pushProgress.blue[blockIndex];
                            
                            if (Math.abs(netProgress) >= block.clicksToMove) {
                                if (netProgress > 0) {
                                    // Red pushes block toward BLUE side (RIGHT = higher %)
                                    block.position = Math.min(95, block.position + config.moveAmount);
                                    state.pushProgress.red[blockIndex] -= block.clicksToMove;
                                    createPushEffect(block.element, 'red');
                                } else {
                                    // Blue pushes block toward RED side (LEFT = lower %)
                                    block.position = Math.max(5, block.position - config.moveAmount);
                                    state.pushProgress.blue[blockIndex] -= block.clicksToMove;
                                    createPushEffect(block.element, 'blue');
                                }
                                
                                block.element.style.left = `${block.position}%`;
                                updateBlockZone(block);
                            }

                            // Update block click display
                            const displayNet = Math.round(state.pushProgress.red[blockIndex] - state.pushProgress.blue[blockIndex]);
                            document.getElementById(`block-clicks-${blockIndex}`).textContent = 
                                displayNet > 0 ? `+${displayNet}` : displayNet;
                        }
                        
                        state.lastKeyPressed[team][blockIndex] = { key: keyIndex, time: Date.now() };

                        // Animate hero
                        const hero = document.getElementById(`hero-${team}-${blockIndex}`);
                        if (hero) {
                            hero.classList.remove('pushing');
                            void hero.offsetWidth;
                            hero.classList.add('pushing');
                        }
                    }
                });
            });

            // Update individual player click displays
            for (let i = 0; i < 3; i++) {
                const redClickEl = document.getElementById(`player-clicks-red-${i}`);
                const blueClickEl = document.getElementById(`player-clicks-blue-${i}`);
                if (redClickEl) redClickEl.textContent = `${state.playerClicks.red[i]} clicks`;
                if (blueClickEl) blueClickEl.textContent = `${state.playerClicks.blue[i]} clicks`;
            }

            updatePowerBars();
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            state.keysPressed[key] = false;

            // Remove glow effect from hero keys in arena
            ['red', 'blue'].forEach(team => {
                config.keyMappings[team].forEach((keys, blockIndex) => {
                    keys.forEach((k, keyIndex) => {
                        if (k === key) {
                            const heroKeyBtns = document.querySelectorAll(`#hero-${team}-${blockIndex} .hero-key-btn`);
                            if (heroKeyBtns[keyIndex]) {
                                heroKeyBtns[keyIndex].classList.remove(`pressed-${team}`);
                            }
                        }
                    });
                });
            });
        }

        // Create push effect
        function createPushEffect(blockEl, team) {
            const indicator = document.createElement('div');
            indicator.className = 'push-indicator';
            indicator.textContent = team === 'red' ? '‚Üí' : '‚Üê';
            indicator.style.color = team === 'red' ? 'var(--team-red)' : 'var(--team-blue)';
            indicator.style.left = '50%';
            indicator.style.top = '20%';
            blockEl.appendChild(indicator);
            setTimeout(() => indicator.remove(), 500);
        }

        // Update block zone highlighting
        function updateBlockZone(block) {
            block.element.classList.remove('in-red-zone', 'in-blue-zone');
            if (block.position < 50) {
                block.element.classList.add('in-blue-zone');
            } else if (block.position > 50) {
                block.element.classList.add('in-red-zone');
            }
        }

        // Update power bars
        function updatePowerBars() {
            const maxClicks = Math.max(state.clicks.red, state.clicks.blue, 1);
            document.getElementById('power-red').style.width = `${(state.clicks.red / maxClicks) * 100}%`;
            document.getElementById('power-blue').style.width = `${(state.clicks.blue / maxClicks) * 100}%`;
        }

        // Update score display
        function updateScoreDisplay() {
            let redScore = 0;
            let blueScore = 0;

            state.blocks.forEach(block => {
                if (block.position < 50) {
                    blueScore++;  // Block is on RED's side = BLUE scores
                } else if (block.position > 50) {
                    redScore++;  // Block is on BLUE's side = RED scores
                }
            });

            scoreRedEl.textContent = redScore;
            scoreBlueEl.textContent = blueScore;
        }

        // Start countdown
        async function startCountdown() {
            state.totalTime = parseInt(timeSelect.value);
            state.timeLeft = state.totalTime;
            timerEl.textContent = state.timeLeft;

            gameOverlay.innerHTML = '<div class="countdown" id="countdown">3</div>';

            // Play countdown audio FIRST (louder than background)
            audioManager.playCountdown().catch(() => {
                console.log('Countdown audio not available');
            });

            // Start background music with slight delay (500ms) so countdown is heard
            setTimeout(() => {
                audioManager.playBackgroundMusic('gameplay', true);
            }, 4000);

            for (let i = 3; i >= 1; i--) {
                document.getElementById('countdown').textContent = i;
                document.getElementById('countdown').style.animation = 'none';
                void document.getElementById('countdown').offsetWidth;
                document.getElementById('countdown').style.animation = 'countPulse 1s ease-in-out';
                await sleep(1000);
            }

            document.getElementById('countdown').textContent = 'PUSH!';
            document.getElementById('countdown').style.color = 'var(--team-red)';
            await sleep(500);

            gameOverlay.classList.add('hidden');
            startMatch();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Start match
        function startMatch() {
            state.isRunning = true;
            
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                timerEl.textContent = state.timeLeft;
                
                if (state.timeLeft <= 10) {
                    timerEl.classList.add('urgent');
                }
                
                updateScoreDisplay();
                
                if (state.timeLeft <= 0) {
                    endMatch();
                }
            }, 1000);
        }

        // End match
        function endMatch() {
            state.isRunning = false;
            clearInterval(state.timerInterval);
            
            // Calculate final scores
            let redScore = 0;
            let blueScore = 0;
            let breakdown = [];

            state.blocks.forEach((block, index) => {
                const weight = config.blocks[index].label;
                if (block.position < 50) {
                    blueScore++;
                    breakdown.push(`${weight}: BLUE SIDE (Blue +1)`);
                } else if (block.position > 50) {
                    redScore++;
                    breakdown.push(`${weight}: RED SIDE (Red +1)`);
                } else {
                    breakdown.push(`${weight}: CENTER (No points)`);
                }
            });

            let winner, winnerClass;
            if (redScore > blueScore) {
                winner = 'TEAM RED WINS!';
                winnerClass = 'red';
            } else if (blueScore > redScore) {
                winner = 'TEAM BLUE WINS!';
                winnerClass = 'blue';
            } else {
                winner = "IT'S A DRAW!";
                winnerClass = 'draw';
            }

            // If in tournament mode, record result and return to game flow
            if (matchData) {
                const gameWinner = winnerClass === 'draw' ? 'red' : winnerClass; // In case of draw, red wins (or could be random)
                localStorage.setItem('gameResult', JSON.stringify({ winner: gameWinner }));

                gameOverlay.innerHTML = `
                    <div class="winner-display">
                        <div class="winner-text ${winnerClass}">${winner}</div>
                        <div class="final-score">RED ${redScore} - ${blueScore} BLUE</div>
                        <div class="score-breakdown">${breakdown.join('<br>')}</div>
                        <button class="start-btn" onclick="returnToTournament()">CONTINUE ‚Üí</button>
                    </div>
                `;
            } else {
                gameOverlay.innerHTML = `
                    <div class="winner-display">
                        <div class="winner-text ${winnerClass}">${winner}</div>
                        <div class="final-score">RED ${redScore} - ${blueScore} BLUE</div>
                        <div class="score-breakdown">${breakdown.join('<br>')}</div>
                        <button class="start-btn" onclick="resetMatch()">PLAY AGAIN</button>
                    </div>
                `;
            }
            gameOverlay.classList.remove('hidden');

            if (winnerClass !== 'draw') {
                createVictoryParticles(winnerClass);
            }
        }

        // Return to tournament flow
        function returnToTournament() {
            window.location.href = 'game-flow.html?game=' + (matchData ? matchData.game : 1);
        }

        // Create victory particles
        function createVictoryParticles(team) {
            const colors = team === 'red' 
                ? ['#ff2d55', '#ff6688', '#ffaacc', '#ffd700'] 
                : ['#00d4ff', '#66e5ff', '#aaeeff', '#ffd700'];
            
            for (let i = 0; i < 120; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.top = '-20px';
                    particle.style.width = `${8 + Math.random() * 12}px`;
                    particle.style.height = particle.style.width;
                    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 3000);
                }, i * 25);
            }
        }

        // Reset match
        function resetMatch() {
            timerEl.classList.remove('urgent');
            gameOverlay.innerHTML = `
                <div class="overlay-title">WALL PUSHING MATCH</div>
                <div class="overlay-subtitle">12 PLAYERS ‚Ä¢ ${timeSelect.value} SECONDS ‚Ä¢ PUSH TO WIN</div>
                <div class="settings-row" style="margin-bottom: 20px;">
                    <div class="setting">
                        <label>TIME:</label>
                        <select id="time-select">
                            <option value="30">30 sec</option>
                            <option value="45">45 sec</option>
                            <option value="60" selected>60 sec</option>
                            <option value="90">90 sec</option>
                            <option value="120">120 sec</option>
                        </select>
                    </div>
                </div>
                <button class="start-btn" id="start-btn">START MATCH</button>
            `;
            document.getElementById('start-btn').addEventListener('click', () => {
                initArena();
                startCountdown();
            });
            gameOverlay.classList.remove('hidden');
        }

        // Event listeners
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        startBtn.addEventListener('click', () => {
            initArena();
            startCountdown();
        });

        timeSelect.addEventListener('change', () => {
            document.querySelector('.overlay-subtitle').textContent =
                `6 PLAYERS ‚Ä¢ ${timeSelect.value} SECONDS ‚Ä¢ PUSH TO WIN`;
        });

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        function devSkip() {
            endMatch();
        }

        initArena();
        renderControls();
    </script>
</body>
</html>