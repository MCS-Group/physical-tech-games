<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical: Tech - ADMIN CONTROL</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --team-red: #ff2d55; --team-red-glow: rgba(255, 45, 85, 0.6);
            --team-blue: #00d4ff; --team-blue-glow: rgba(0, 212, 255, 0.6);
            --gold: #ffd700; --gold-glow: rgba(255, 215, 0, 0.4);
            --dark-bg: #0a0a12; --arena-bg: #12121a; --panel-bg: rgba(0, 0, 0, 0.5);
            --success: #00ff88; --danger: #ff4444;
            --purple: #9945ff;
        }
        body {
            background: var(--dark-bg); min-height: 100vh; font-family: 'Orbitron', sans-serif;
            overflow-x: hidden; padding: 15px; color: white;
        }
        .header {
            text-align: center; margin-bottom: 20px; padding: 20px;
            background: var(--panel-bg); border-radius: 15px; border: 2px solid rgba(255, 215, 0, 0.3);
        }
        .title { font-family: 'Black Ops One', cursive; font-size: 2rem; }
        .admin-badge {
            background: var(--danger); color: white; padding: 5px 10px; border-radius: 5px;
            font-family: 'Press Start 2P', cursive; font-size: 0.5rem; vertical-align: middle; margin-left: 10px;
        }
        
        .main-layout { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        
        /* Game Grid */
        .teams-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .team-card { 
            background: var(--panel-bg); border: 2px solid #333; border-radius: 10px; padding: 10px; 
            text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .team-card.selected { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
        .team-card.eliminated { opacity: 0.5; border-color: var(--danger); }
        
        /* Scoreboard Table */
        .scoreboard-container { background: var(--arena-bg); border: 3px solid #333; border-radius: 15px; padding: 20px; }
        .scoreboard-table { width: 100%; border-collapse: separate; border-spacing: 4px; }
        .scoreboard-table th { background: #222; padding: 10px; font-size: 0.7rem; color: var(--gold); }
        .scoreboard-table td { background: rgba(255,255,255,0.05); padding: 8px; text-align: center; font-size: 0.8rem; }
        .cell-won { background: rgba(0, 255, 136, 0.2) !important; border: 1px solid var(--success); }
        .cell-lost { background: rgba(255, 68, 68, 0.1) !important; border: 1px solid var(--danger); opacity: 0.6; }

        /* Control Panel */
        .panel { background: var(--arena-bg); border: 2px solid #333; border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .panel-title { color: var(--gold); font-family: 'Black Ops One'; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .select-group { margin-bottom: 15px; }
        select { width: 100%; padding: 10px; background: #000; color: white; border: 1px solid #555; border-radius: 5px; font-family: 'Orbitron'; }
        
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Black Ops One'; }
        .btn-red { background: var(--team-red); color: white; }
        .btn-blue { background: var(--team-blue); color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-danger { background: #a00; color: white; }
        
        .status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-light.on { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .status-light.off { background: #333; }

        .current-match-display { 
            background: #000; padding: 10px; border-radius: 5px; margin-bottom: 10px; text-align: center; border: 1px solid #444; 
        }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: #1a1a1a; padding: 30px; border-radius: 15px; border: 2px solid var(--gold); width: 400px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">PHYSICAL: TECH <span class="admin-badge">ADMIN CONTROL</span></h1>
        <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
            <span class="status-light on" id="syncStatus"></span> SYSTEM SYNCED ‚Ä¢ STORAGE: physicalTechTournament
        </div>
    </div>

    <div class="main-layout">
        <!-- LEFT COLUMN: VISUALIZATION -->
        <div>
            <div class="teams-grid" id="teamsGrid">
                <!-- Teams injected here -->
            </div>

            <div class="scoreboard-container">
                <h3 style="margin-bottom:10px; color:var(--gold);">TOURNAMENT STATE</h3>
                <table class="scoreboard-table">
                    <thead>
                        <tr>
                            <th>TEAM</th>
                            <th>GAME 1 (8‚Üí4)</th>
                            <th>GAME 2 (4‚Üí2)</th>
                            <th>GAME 3 (2‚Üí1)</th>
                            <th>GAME 4<br><span style="font-size: 0.4rem; color: #888;">FINAL 4v4</span></th>
                        </tr>
                    </thead>
                    <tbody id="scoreBody">
                        <!-- Scores injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT COLUMN: CONTROLS -->
        <div class="controls-column">
            
            <!-- CURRENT MATCH CONTROL -->
            <div class="panel">
                <h3 class="panel-title">üéÆ MATCH OVERRIDE</h3>
                <p style="font-size: 0.7rem; color:#888; margin-bottom: 10px;">Force set the current match or declare a winner manually.</p>
                
                <div class="select-group">
                    <label style="font-size:0.7rem; color:#aaa;">CURRENT GAME PHASE</label>
                    <select id="gamePhaseSelect" onchange="updatePhase()">
                        <option value="1">GAME 1: WALL PUSH</option>
                        <option value="2">GAME 2: HANGING</option>
                        <option value="3">GAME 3: IRON BALL</option>
                        <option value="4">GAME 4: FINAL</option>
                    </select>
                </div>

                <div class="current-match-display" id="activeMatchDisplay">
                    NO ACTIVE MATCH
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-red" onclick="forceWin('red')">RED WINS</button>
                    <button class="btn btn-blue" onclick="forceWin('blue')">BLUE WINS</button>
                </div>
            </div>

            <!-- MANUAL MATCHUP SETUP -->
            <div class="panel">
                <h3 class="panel-title">üõ†Ô∏è MANUAL SETUP</h3>
                <div class="select-group">
                    <select id="teamRedSelect"><option>Select Red Team...</option></select>
                </div>
                <div class="select-group">
                    <select id="teamBlueSelect"><option>Select Blue Team...</option></select>
                </div>
                <button class="btn btn-gold" onclick="forceMatchSetup()">SET AS CURRENT MATCH</button>
            </div>

            <!-- SYSTEM ACTIONS -->
            <div class="panel">
                <h3 class="panel-title">‚ö†Ô∏è DANGER ZONE</h3>
                <button class="btn btn-gold" onclick="forceRefresh()">üîÑ FORCE DISPLAY REFRESH</button>
                <button class="btn btn-danger" onclick="confirmReset()">‚ò¢Ô∏è RESET TOURNAMENT</button>
            </div>

        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <h2 style="color:var(--danger); margin-bottom:20px;">CONFIRM RESET</h2>
            <p style="margin-bottom:20px; color:#ccc;">This will wipe all tournament history and restart from Game 1. This cannot be undone.</p>
            <button class="btn btn-danger" onclick="executeReset()">YES, WIPE EVERYTHING</button>
            <button class="btn btn-gold" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <script src="players.js"></script>
    <script src="game-state.js"></script>
    <script>
        // Init
        function init() {
            render();
            // Auto-refresh to keep admin UI in sync with game flow
            setInterval(render, 1000);
        }

        function render() {
            const state = getState();
            renderTeams(state);
            renderScoreboard(state);
            renderControls(state);
            updateStatusLight(state);
        }

        function updateStatusLight(state) {
            const light = document.getElementById('syncStatus');
            light.className = state.tournamentStarted ? 'status-light on' : 'status-light off';
        }

        // Render Teams Grid
        function renderTeams(state) {
            const container = document.getElementById('teamsGrid');
            container.innerHTML = '';
            
            // Determine eliminations
            const eliminated = new Set();
            for(let g=1; g<=3; g++) {
                (state.results[g] || []).forEach(r => {
                    if (r.winner === 'red') eliminated.add(r.blue);
                    else eliminated.add(r.red);
                });
            }

            Object.values(COMBINED_TEAMS).forEach(team => {
                const isEliminated = eliminated.has(team.id);
                const div = document.createElement('div');
                div.className = `team-card ${isEliminated ? 'eliminated' : ''}`;
                div.innerHTML = `
                    <div style="font-family:'Black Ops One'; color:var(--gold);">C${team.id}</div>
                    <div style="font-size:0.6rem;">${team.name}</div>
                `;
                container.appendChild(div);
            });
        }

        // Render Scoreboard Table
        function renderScoreboard(state) {
            const tbody = document.getElementById('scoreBody');
            tbody.innerHTML = '';

            Object.values(COMBINED_TEAMS).forEach(team => {
                let rowHtml = `<td><span style="color:#888;">C${team.id}</span> ${team.name}</td>`;
                
                for(let g=1; g<=4; g++) {
                    let result = '';
                    const matches = state.results[g] || [];
                    const match = matches.find(m => 
                        !m.isOriginalTeams && (m.red === team.id || m.blue === team.id)
                    );

                    if (match) {
                        const won = (match.winner === 'red' && match.red === team.id) || 
                                    (match.winner === 'blue' && match.blue === team.id);
                        rowHtml += `<td class="${won ? 'cell-won' : 'cell-lost'}">${won ? 'WIN' : 'OUT'}</td>`;
                    } else if (g === 4 && state.bracket.finalist === team.id) {
                        // Special case for finalist in Game 4
                        const finalMatches = state.results[4] || [];
                        if (finalMatches.length > 0) {
                             rowHtml += `<td class="cell-won">PLAYED</td>`; // Simplified for admin view
                        } else {
                             rowHtml += `<td>PENDING</td>`;
                        }
                    } else {
                        rowHtml += `<td>-</td>`;
                    }
                }
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;
            });
        }

        // Render Controls & Selects
        function renderControls(state) {
            // Update Active Match Display
            const setup = state.currentMatchSetup;
            const display = document.getElementById('activeMatchDisplay');
            
            if (setup && setup.redTeam && setup.blueTeam) {
                let rName, bName;
                if (setup.isOriginalTeams) {
                    rName = TEAMS[setup.redTeam].name;
                    bName = TEAMS[setup.blueTeam].name;
                } else {
                    rName = COMBINED_TEAMS[setup.redTeam].name;
                    bName = COMBINED_TEAMS[setup.blueTeam].name;
                }
                display.innerHTML = `
                    <div style="color:var(--gold); font-size:0.7rem; margin-bottom:5px;">ACTIVE ON SCREEN</div>
                    <span style="color:var(--team-red);">${rName}</span> 
                    <span style="color:#666;">VS</span> 
                    <span style="color:var(--team-blue);">${bName}</span>
                `;
            } else {
                display.innerHTML = '<span style="color:#666;">NO MATCH ACTIVE</span>';
            }

            // Populate Team Selects (Only if empty to avoid resetting user selection)
            const rSelect = document.getElementById('teamRedSelect');
            if (rSelect.options.length <= 1) {
                populateTeamSelects();
            }
        }

        function populateTeamSelects() {
            const rSelect = document.getElementById('teamRedSelect');
            const bSelect = document.getElementById('teamBlueSelect');
            
            // Add Combined Teams
            Object.values(COMBINED_TEAMS).forEach(t => {
                const opt = `<option value="C${t.id}">C${t.id}: ${t.name}</option>`;
                rSelect.innerHTML += opt;
                bSelect.innerHTML += opt;
            });
            
            // Add Original Teams (for Game 4)
            Object.values(TEAMS).forEach(t => {
                const opt = `<option value="T${t.id}">T${t.id}: ${t.name}</option>`;
                rSelect.innerHTML += opt;
                bSelect.innerHTML += opt;
            });
        }

        // --- ACTIONS ---

        function updatePhase() {
            const phase = parseInt(document.getElementById('gamePhaseSelect').value);
            updateState({ currentGame: phase });
        }

        function forceMatchSetup() {
            const rVal = document.getElementById('teamRedSelect').value;
            const bVal = document.getElementById('teamBlueSelect').value;
            const gamePhase = parseInt(document.getElementById('gamePhaseSelect').value);

            if (!rVal || !bVal || rVal === bVal) {
                alert("Please select two different teams.");
                return;
            }

            const parseId = (val) => parseInt(val.substring(1));
            const isOriginal = rVal.startsWith('T');

            updateState({
                currentScreen: 'preview', // Force preview screen
                currentMatchSetup: {
                    game: gamePhase,
                    matchIndex: 99, // Admin override index
                    redTeam: parseId(rVal),
                    blueTeam: parseId(bVal),
                    redPlayers: [], // Admin doesn't need to pick players to force start
                    bluePlayers: [],
                    selectionPhase: 'ready',
                    isOriginalTeams: isOriginal
                }
            });
        }

        function forceWin(winner) {
            const state = getState();
            if (!state.currentMatchSetup || !state.currentMatchSetup.redTeam) {
                alert("No active match to decide!");
                return;
            }
            
            if (confirm(`Declare ${winner.toUpperCase()} as winner?`)) {
                recordMatchResult(winner);
                // Reset setup after recording
                updateState({
                    currentMatchSetup: { 
                        game: null, redTeam: null, blueTeam: null 
                    } 
                });
            }
        }

        function forceRefresh() {
            // Toggles a dummy timestamp to force storage event in other tabs
            updateState({ lastRefresh: Date.now() });
        }

        function confirmReset() {
            document.getElementById('resetModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('resetModal').classList.remove('show');
        }

        function executeReset() {
            resetTournament();
            closeModal();
            location.reload();
        }

        // Listen for storage changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'physicalTechTournament') {
                render();
            }
        });

        init();
    </script>
</body>
</html>